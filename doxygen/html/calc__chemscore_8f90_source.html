<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>qsource: calc_chemscore.f90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">qsource
   &#160;<span id="projectnumber">5.7</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_9e51036813d6151dfecc72d5fa7c02b3.html">Users</a></li><li class="navelem"><a class="el" href="dir_cc5e21463aaf155987874daa84db6d6e.html">esguerra</a></li><li class="navelem"><a class="el" href="dir_284fb529e48f121476ccd3fb306e3724.html">software</a></li><li class="navelem"><a class="el" href="dir_4a0e131d5eef10c09c58134c0408801b.html">qsource</a></li><li class="navelem"><a class="el" href="dir_c37daa0d9a5d62d04ec5bab6920011a0.html">development</a></li><li class="navelem"><a class="el" href="dir_2dba9ad2b677b18ac1a30973c57ed176.html">esguerra</a></li><li class="navelem"><a class="el" href="dir_1aaa6e4bc4376284103de70ac85f4569.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">calc_chemscore.f90</div>  </div>
</div><!--header-->
<div class="contents">
<a href="calc__chemscore_8f90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">! (C) 2000 Uppsala Molekylmekaniska HB, Uppsala, Sweden</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">! calc_chemscore.f90</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">!Kajsa Ljungberg 1998-06-11</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">!Implementation of a scoring function by Eldridge et al.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">!JCAMD 11 (1997) 425-445.</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">!Integration into QCalc5 by Peter Hanspers</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html">    8</a></span>&#160;<span class="keyword">module</span> <a class="code" href="classcalc__chemscore.html">calc_chemscore</a></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keywordtype">use </span><a class="code" href="classcalc__base.html">calc_base</a></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keywordtype">use </span><a class="code" href="classmaskmanip.html">maskmanip</a></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keywordtype">use </span><a class="code" href="classtrj.html">trj</a></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keywordtype">use </span><a class="code" href="classprmfile.html">prmfile</a></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keywordtype">use </span><a class="code" href="classindexer.html">indexer</a></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keywordtype">use </span><a class="code" href="classqatom.html">qatom</a></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a0a128ccdf119ded09ab8d3ef43bae64c">   18</a></span>&#160;<span class="keywordtype">real</span>                    :: score</div>
<div class="line"><a name="l00019"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a4cd182377bd9390c602bd0a0c169a345">   19</a></span>&#160;<span class="keywordtype">integer</span>                 :: frame</div>
<div class="line"><a name="l00020"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a3b2724ed780bdae65bbbec15ac8422c8">   20</a></span>&#160;<span class="keywordtype">integer</span>                 :: stat</div>
<div class="line"><a name="l00021"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a5579c59a11b61014e8a2d04bd984678e">   21</a></span>&#160;<span class="keywordtype">integer</span>                 :: i</div>
<div class="line"><a name="l00022"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a47f6a15d75ed5c28132a8cc8c8141416">   22</a></span>&#160;<span class="keywordtype">character(len=4)</span>        :: trj_type</div>
<div class="line"><a name="l00023"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a6c1dfab249f0271c1032ed943ecb6d86">   23</a></span>&#160;<span class="keywordtype">character*80</span>            :: top_file, fep_file</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__precalc__type.html">   25</a></span>&#160;<span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1score__precalc__type.html">score_precalc_type</a></div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__precalc__type.html#ab013ebbe98e9620a70428fd3fed112e9">   26</a></span>&#160;        <span class="keywordtype">character(len=80)</span>       :: chFilename           <span class="comment">! name of re file if one is given</span></div>
<div class="line"><a name="l00027"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__precalc__type.html#acf3304a666672e5e7ba6470e3947c038">   27</a></span>&#160;        <span class="keywordtype">integer</span>                                         :: iType                                <span class="comment">! 1 = top calculation, 2 = restart calculation</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">end type </span><a class="code" href="structcalc__chemscore_1_1score__precalc__type.html">score_precalc_type</a></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html">   30</a></span>&#160;<span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1score__type.html">score_type</a>                                                                                 <span class="comment">! structure tp keep track of scoring data</span></div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#a6d356f21f833fb8a993132fafce94fbd">   31</a></span>&#160;        <span class="keywordtype">character(len=80)</span>               :: chFilename   <span class="comment">! either name of restart file, &#39;top&#39; or empty if trajectory frame</span></div>
<div class="line"><a name="l00032"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#a5e6eea1dc22a81b39f2f631c9c71ad80">   32</a></span>&#160;        <span class="keywordtype">integer</span>                                                 :: frame                        <span class="comment">! empty if chReFilename is present</span></div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#ab653acb22618b073d6f5912c97ea6109">   33</a></span>&#160;        <span class="keywordtype">real(8)</span>                                                 :: score</div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#a42510c078a0421d5315ea9643fb5550e">   34</a></span>&#160;        <span class="keywordtype">real(8)</span>                                                 :: h_bonds</div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#a68dfbf6bcecd3234b372b142f21dfdc9">   35</a></span>&#160;        <span class="keywordtype">real(8)</span>                                                 :: metal</div>
<div class="line"><a name="l00036"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#a9cc42cf22a9a010f4e77daf6a4cb3491">   36</a></span>&#160;        <span class="keywordtype">real(8)</span>                                                 :: lipophil</div>
<div class="line"><a name="l00037"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__type.html#a06b967473b197c05a0a3d25d5b864e50">   37</a></span>&#160;        <span class="keywordtype">real(8)</span>                                                 :: rot_bond</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">end type </span><a class="code" href="structcalc__chemscore_1_1score__type.html">score_type</a></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">!constants</span></div>
<div class="line"><a name="l00041"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a035d2a19bada1d6c65c8ac2d7574c263">   41</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>                                              ::      MAX_MASKS = 10</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">!module variables</span></div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a586a968234f3a2338f8f7a045122ccb7">   43</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1score__precalc__type.html">score_precalc_type</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>,<span class="keywordtype">private</span>        :: aPrecalc(:)  <span class="comment">! array of pre-calculations</span></div>
<div class="line"><a name="l00044"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a55ea4b33c86233768f0a6f859c2023b6">   44</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span>                                                        :: iPrecalc             <span class="comment">! current number of pre-calcs added</span></div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a5bff437603dc25b9d5bd6537a8039f2d">   45</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span>                                                        :: maxPrecalc   <span class="comment">! number of pre-calc elements allocated</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ab15cb5a3ebf1b4cff3c3a65acbf76159">   47</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1score__type.html">score_type</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>,<span class="keywordtype">private</span>                ::      aScore(:)                               <span class="comment">! framewise scoring info</span></div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a410140d396d152254ee380ca143a2171">   48</a></span>&#160;        <span class="keywordtype">integer</span>                                                                 ::      nScores, maxScores              <span class="comment">! number of elements in aScore, number of allocated elements of aScore</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ae95a0840a35137beed3bcc7ff4345626">   50</a></span>&#160;        <span class="keywordtype">type(</span>mask_type<span class="keywordtype">)</span>, <span class="keywordtype">private</span>, <span class="keywordtype">target</span>        ::      masks(MAX_MASKS)</div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a7a4e890daa5f6464f57b789a0a0a82a9">   51</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span>                                        ::      Nmasks = 0</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__coord__type.html">   53</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1score__coord__type.html">score_coord_type</a></div>
<div class="line"><a name="l00054"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__coord__type.html#abba8f44e4bea4ac623e9c1ab271a6ded">   54</a></span>&#160;                <span class="keywordtype">real(8)</span>, <span class="keywordtype">pointer</span>                                ::      xr(:)</div>
<div class="line"><a name="l00055"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1score__coord__type.html#ae917506bef9aa4646094824d5c5a606b">   55</a></span>&#160;                <span class="keywordtype">real(8)</span>                                                 ::      xrcm(3)</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1score__coord__type.html">score_coord_type</a></div>
<div class="line"><a name="l00057"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ab1a63356a1ac975b5dd189e550e7e143">   57</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1score__coord__type.html">score_coord_type</a><span class="keywordtype">)</span>, <span class="keywordtype">private</span>         ::      coords(MAX_MASKS)</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1wat.html">   59</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1wat.html">wat</a></div>
<div class="line"><a name="l00060"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1wat.html#ae92261d880319f2bc8ba2cc84172623d">   60</a></span>&#160;                <span class="keywordtype">integer(AI)</span>                                     ::      O, H1, H2               <span class="comment">!topology numbers</span></div>
<div class="line"><a name="l00061"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1wat.html#a2e3ecfc1a3bb401e862c54ff6b7fd75e">   61</a></span>&#160;                <span class="keywordtype">real</span>                                            ::      score                   <span class="comment">!H-bond score with receptor</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1wat.html">wat</a></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        </div>
<div class="line"><a name="l00064"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1donor.html">   64</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1donor.html">donor</a></div>
<div class="line"><a name="l00065"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1donor.html#a4d1a0a2acb614f07bf76ea0024cc5fad">   65</a></span>&#160;                <span class="keywordtype">integer(AI)</span>                                     ::      heavy,hydr              <span class="comment">!topology numbers for atoms in H-bond donor</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1donor.html">donor</a></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1lipos.html">   68</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1lipos.html">lipos</a>                                                                                      <span class="comment">!return type for lip_atom</span></div>
<div class="line"><a name="l00069"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1lipos.html#aefb2a7a91aed4bdccfca9e13322192a8">   69</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      n_lip                   <span class="comment">!number of lipophilic atoms</span></div>
<div class="line"><a name="l00070"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1lipos.html#a341243244ff5b54613d2c4f3a0900129">   70</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      n_nonlip                <span class="comment">!number of heavy, non-lipophilic atoms</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1lipos.html">lipos</a></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        </div>
<div class="line"><a name="l00073"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1bond__pointer.html">   73</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1bond__pointer.html">bond_pointer</a>                                                                       <span class="comment">!pointer to the datatype q_bond</span></div>
<div class="line"><a name="l00074"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1bond__pointer.html#a81412f914796a27ac52ec9bb35631cef">   74</a></span>&#160;                <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>            ::      qb                              <span class="comment">!needed for array of q_bonds in type q_atom</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1bond__pointer.html">bond_pointer</a></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        </div>
<div class="line"><a name="l00077"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html">   77</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a>                     </div>
<div class="line"><a name="l00078"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#a45781d30e4d6635063993f5cc255f0d5">   78</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      top_nr                                                                  <span class="comment">! atom number in topology               </span></div>
<div class="line"><a name="l00079"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#a278aca77377ccabcd177be060a8a4c44">   79</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      n                                                                                               <span class="comment">!number of bonds                                                                </span></div>
<div class="line"><a name="l00080"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#ab8271d5ededd6c275ae76897c65a1655">   80</a></span>&#160;                <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1bond__pointer.html">bond_pointer</a><span class="keywordtype">)</span>,<span class="keywordtype">dimension(1:6)</span>               ::      bd              <span class="comment">!pointers to the bonds</span></div>
<div class="line"><a name="l00081"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#aa8b0c72fdf2f0bb5c4485f5af46abbfc">   81</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      contact                         <span class="comment">!if     closer than r to any receptor atom </span></div>
<div class="line"><a name="l00082"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#a53f533a342d764a9ed38a4e5929bdb70">   82</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      at_type                         <span class="comment">!if lipophilic 2, if other heavy 1, if hydrogen 0 </span></div>
<div class="line"><a name="l00083"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#a88f13993f1131b735ed1b57383871484">   83</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      hybrid                          <span class="comment">!if included sp3 then 3, if included sp2 then 2, others 0</span></div>
<div class="line"><a name="l00084"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#af47778363b2675c3ccb7992cafd5b448">   84</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      been_there              <span class="comment">!flag used in recursive routines, to avoid eternal loops</span></div>
<div class="line"><a name="l00085"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#aae893d503a84fb04f0063651d4b32012">   85</a></span>&#160;                <span class="keywordtype">logical</span>,<span class="keywordtype">pointer</span>         ::      cyclic(:)                       <span class="comment">!array of logicals, one for each ring, true if part of that ring</span></div>
<div class="line"><a name="l00086"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__atom.html#a8ea40a20405d4aa8b1b03cf478d985da">   86</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      active                          <span class="comment">!same as been_there</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a>                                                                         </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        </div>
<div class="line"><a name="l00089"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html">   89</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a></div>
<div class="line"><a name="l00090"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#a93277ad371a3d42f2f9db5ca5a9851b2">   90</a></span>&#160;                <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>            ::      a,b                                     <span class="comment">!pointers to two bonded atoms</span></div>
<div class="line"><a name="l00091"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#aa83f76483887f14b56530a0c6b7fbcdd">   91</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      rotatable                       <span class="comment">!if not part of ring and sp3-sp3 or sp3-sp2 bond</span></div>
<div class="line"><a name="l00092"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#a18fdd505bce8f6acbd49cf99010d05bc">   92</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      acontact,bcontact       <span class="comment">!if a and b in contact with receptor, only used if rotatable</span></div>
<div class="line"><a name="l00093"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#a2ac95d010aaab835c13180975ec2eac2">   93</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      been_there</div>
<div class="line"><a name="l00094"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#a238ba76aa6e48069fbf597217892b6a3">   94</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      a_nonlip,b_nonlip       <span class="comment">!number of non-lipophilic heavy atoms on a-side and b-side of bond</span></div>
<div class="line"><a name="l00095"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#aa36febc28cb8280703698681883fce2e">   95</a></span>&#160;                <span class="keywordtype">integer</span>                                         ::      a_lip,b_lip                     <span class="comment">!number of lipophilic heavy atoms on a-side and b-side of bond</span></div>
<div class="line"><a name="l00096"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#a4571c0cb4812a7c125d3160f07f9e384">   96</a></span>&#160;                <span class="keywordtype">logical</span>,<span class="keywordtype">pointer</span>                         ::      cyclic(:)                       </div>
<div class="line"><a name="l00097"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1q__bond.html#a2edb791da9cb56771f1a27cab956e665">   97</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      active</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        </div>
<div class="line"><a name="l00100"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ab1e216a48152826de41fffb5a9d2d48e">  100</a></span>&#160;        <span class="keywordtype">integer(AI)</span>, <span class="keywordtype">allocatable</span>        ::      lph_r(:)        <span class="comment">!topology number for all lipophilic atoms in the receptor</span></div>
<div class="line"><a name="l00101"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a39c1639390221a6c4a2a8edba8cb98cc">  101</a></span>&#160;        <span class="keywordtype">integer(AI)</span>, <span class="keywordtype">allocatable</span>        ::      lph_l(:)        <span class="comment">!                               &#39;&#39;                                                   the ligand</span></div>
<div class="line"><a name="l00102"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#aa414095b9d9b645a440912b5a2022214">  102</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1donor.html">donor</a><span class="keywordtype">)</span>, <span class="keywordtype">allocatable</span>        ::      hbd_r(:)        <span class="comment">!H-bond donor in receptor</span></div>
<div class="line"><a name="l00103"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a38023298e024f0fc25e3f31f390cffb8">  103</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1donor.html">donor</a><span class="keywordtype">)</span>, <span class="keywordtype">allocatable</span>        ::      hbd_l(:)        <span class="comment">!  &#39;&#39;            ligand</span></div>
<div class="line"><a name="l00104"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a2d5806a7dbd81e921bd36250e2c5e625">  104</a></span>&#160;        <span class="keywordtype">integer(AI)</span>, <span class="keywordtype">allocatable</span>        ::      hba_r(:)        <span class="comment">!H-bond acceptor atoms in receptor </span></div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#acd1541a9ea18346f52dd8b3d8690928b">  105</a></span>&#160;        <span class="keywordtype">integer(AI)</span>, <span class="keywordtype">allocatable</span>        ::      hba_l(:)        <span class="comment">!      &#39;&#39;                 ligand</span></div>
<div class="line"><a name="l00106"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a8d928ea8b4d7dd3d55c900989dd2349a">  106</a></span>&#160;        <span class="keywordtype">integer(AI)</span>, <span class="keywordtype">allocatable</span>        ::      met_r(:)        <span class="comment">!metal atoms in the receptor</span></div>
<div class="line"><a name="l00107"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ab81e8c2249c6c29046df0cf2d5dc9cac">  107</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1wat.html">wat</a><span class="keywordtype">)</span>, <span class="keywordtype">allocatable</span>          ::      waters(:)       <span class="comment">!water molecules</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        </div>
<div class="line"><a name="l00109"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a967fddb2385d770370d95b0d762617a6">  109</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span>            ::      pol_con(:)      <span class="comment">!connections for potentially polar atoms</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                                                                                                </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        </div>
<div class="line"><a name="l00112"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#afb82a7d43bbfe0502a2131ea40819b60">  112</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">private</span>,<span class="keywordtype">allocatable</span>,<span class="keywordtype">target</span> ::      q_atoms(:)              <span class="comment">! atoms in ligand</span></div>
<div class="line"><a name="l00113"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ad19a31c4b53236429ca22cc9f16a8283">  113</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">private</span>,<span class="keywordtype">allocatable</span>,<span class="keywordtype">target</span> ::      q_bonds(:)              <span class="comment">! bonds in ligand</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="comment">!numbers of each of the atom types</span></div>
<div class="line"><a name="l00116"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a398cedd02c40d7f982a22ccc167e29f0">  116</a></span>&#160;        <span class="keywordtype">integer</span>                                         ::      nlph_r, nlph_l, nhbd_r, nhbd_l</div>
<div class="line"><a name="l00117"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a9620ce63e8c0a9af29f2e28281526f61">  117</a></span>&#160;        <span class="keywordtype">integer</span>                                         ::      nhba_r, nhba_l, nmet_r, nwaters,nqbonds</div>
<div class="line"><a name="l00118"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a03c8c74285e823b77a4b9342b74063ef">  118</a></span>&#160;        <span class="keywordtype">integer</span>                                         ::      nhbd_prot, nhba_prot</div>
<div class="line"><a name="l00119"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a86fcc5a701ba3b1900908778c29fccc1">  119</a></span>&#160;        <span class="keywordtype">integer</span>                                         ::      nrings          <span class="comment">!number of rings in the ligand</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;        </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment">!lists of the atom type categories</span></div>
<div class="line"><a name="l00122"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a95d7b76641cfc63037276718a6c0d409">  122</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>                              ::      LIPO=1, METAL=2, SULPHUR=3, ACCEPTOR=4</div>
<div class="line"><a name="l00123"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a09ae8a1f9f2ef13e71fcec99d065126d">  123</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>                              ::      SP3=5, SP2=6, SP3_N=7, PL_N=8</div>
<div class="line"><a name="l00124"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#aee2123f93427e62198b19acbe63a1a01">  124</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>                              ::      HYDROGEN=9, OXYGEN=10, CARBON_LIPO=11</div>
<div class="line"><a name="l00125"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a9da5d81c112c26d8c8911ad5c100be1b">  125</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>                              ::      CARBONYL_CARBON=12, CARBONYL_OXYGEN=13</div>
<div class="line"><a name="l00126"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a21d027f3f912e3305b65b0db008c5053">  126</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">parameter</span>                              ::      NPROPS=13</div>
<div class="line"><a name="l00127"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a7e04d3fd8fe18efe87ef287cc54572dd">  127</a></span>&#160;        <span class="keywordtype">character*(*)</span>, <span class="keywordtype">parameter</span>                ::      file_heading(NPROPS) = [ &amp;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;                <span class="stringliteral">&#39;lipophilic     &#39;</span>, &amp;</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;                <span class="stringliteral">&#39;metal          &#39;</span>, &amp;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;                <span class="stringliteral">&#39;sulphur        &#39;</span>, &amp;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;                <span class="stringliteral">&#39;acceptor       &#39;</span>, &amp;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;                <span class="stringliteral">&#39;sp3            &#39;</span>, &amp;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;                <span class="stringliteral">&#39;sp2            &#39;</span>, &amp;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;                <span class="stringliteral">&#39;sp3_nitrogen   &#39;</span>, &amp;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                <span class="stringliteral">&#39;planar_nitrogen&#39;</span>, &amp;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;                <span class="stringliteral">&#39;hydrogen       &#39;</span>, &amp;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;                <span class="stringliteral">&#39;oxygen         &#39;</span>, &amp;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;                <span class="stringliteral">&#39;carbon_lipo    &#39;</span>, &amp;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;                <span class="stringliteral">&#39;carbonyl_carbon&#39;</span>, &amp;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;                <span class="stringliteral">&#39;carbonyl_oxygen&#39;</span>]</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;        </div>
<div class="line"><a name="l00142"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1atom__data__type.html">  142</a></span>&#160;        <span class="keyword">type</span> <a class="code" href="structcalc__chemscore_1_1atom__data__type.html">atom_data_type</a></div>
<div class="line"><a name="l00143"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1atom__data__type.html#aa6e41ac049f305039fdd01be8860b0b9">  143</a></span>&#160;                <span class="keywordtype">real</span>                                            ::      radius</div>
<div class="line"><a name="l00144"></a><span class="lineno"><a class="code" href="structcalc__chemscore_1_1atom__data__type.html#acdc604d24290d9ddaa57870193661416">  144</a></span>&#160;                <span class="keywordtype">logical</span>                                         ::      prop(NPROPS)</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="keyword">        end type </span><a class="code" href="structcalc__chemscore_1_1atom__data__type.html">atom_data_type</a></div>
<div class="line"><a name="l00146"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a4de84d0dd19f0b32599251fb0812813c">  146</a></span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1atom__data__type.html">atom_data_type</a><span class="keywordtype">)</span>, <span class="keywordtype">allocatable</span> ::atom_data(:)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment">!No record is kept of polar(non H-bonding) atoms</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;        </div>
<div class="line"><a name="l00150"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ab620b7f585ddb65438bfcf1bd78a83b0">  150</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span>            ::      iqatom(:)       <span class="comment">!one element per atom, 0 if not Q-atom, </span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;                                                                                                <span class="comment">!else number in iqseq (ligand)</span></div>
<div class="line"><a name="l00152"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a0a9f262f34f33777a05e38e993df8a66">  152</a></span>&#160;        <span class="keywordtype">real</span>,<span class="keywordtype">allocatable</span>                        ::      vdwr(:)         <span class="comment">!van der Waals radius of each atom      </span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ae6953c3a16fa9621b6b6c4686a740711">  154</a></span>&#160;        <span class="keywordtype">character*80</span>                            ::      atom_data_file</div>
<div class="line"><a name="l00155"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a7e693ad770c136c0edc287994e1f44e2">  155</a></span>&#160;        <span class="keywordtype">character*80</span>                            ::  coord_file  </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        </div>
<div class="line"><a name="l00157"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a750abcd708dc4cad10da3fd9b3e3fea2">  157</a></span>&#160;        <span class="keywordtype">real</span>                                            ::      hbond_term,metal_term,lipo_term,rot_term        <span class="comment">!result from score</span></div>
<div class="line"><a name="l00158"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a8e30cdec6eac436e2c66c8042077f8fd">  158</a></span>&#160;        <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>                         ::      dGconst=-5.48, dGhbond=-3.34, dGmetal=-6.03 </div>
<div class="line"><a name="l00159"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a2ffd6fa0a78e73647da9a04acf90124e">  159</a></span>&#160;        <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span>                         ::      dGlipo=-0.117, dGrot=2.56</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        </div>
<div class="line"><a name="l00161"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#aaefd70da86dc7e096e752cb92073e59a">  161</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span>                        ::      bDoTopcalc              <span class="comment">! boolean flag</span></div>
<div class="line"><a name="l00162"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ae221adc2a0ae83b528c10fe7b2493c80">  162</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span>                        ::      iRestartCalc=-1 <span class="comment">! flag to indicate if doing calcs on restart file or not</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a33ff8ef2871f086a64634d3af142e368">  164</a></span>&#160;        <span class="keywordtype">logical</span>, <span class="keywordtype">private</span>                        ::      bUseXIN = .false.               <span class="comment">! boolean flag to indicate use of xin instead of xtop</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div>
<div class="line"><a name="l00166"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#af393275025caa6267b2c9ee46fadd3d7">  166</a></span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">private</span>                        :: warn                                         <span class="comment">! flag to indicate if any warnings were displayed</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="keyword">contains</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;        </div>
<div class="line"><a name="l00170"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#af6e984aa1653e69de2ec2a501c90913d">  170</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#af6e984aa1653e69de2ec2a501c90913d">score_initialize</a></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        nscores = 0</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;        maxscores = 16</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keyword">allocate</span>(ascore(maxscores))</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#af6e984aa1653e69de2ec2a501c90913d">score_initialize</a></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ae933b171a206adf49ec5cde460082f5a">  176</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#ae933b171a206adf49ec5cde460082f5a">chemscore_finalize</a></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;        <span class="keywordflow">if</span>(warn.ne.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;                <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(a,i3,a)&#39;</span>) <span class="stringliteral">&#39;WARNING: There were &#39;</span>, warn, <span class="stringliteral">&#39; warnings.&#39;</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;                <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(a)&#39;</span>) <span class="stringliteral">&#39;ChemScore finished succesfully.&#39;</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#ae933b171a206adf49ec5cde460082f5a">chemscore_finalize</a></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div>
<div class="line"><a name="l00184"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ac981dadd7632147eefe3240bada21d79">  184</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#ac981dadd7632147eefe3240bada21d79">log_frame</a>(iFrame)                                    ! logs scoring results for frame</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;        <span class="comment">! args</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>             :: iframe                       <span class="comment">! current frame</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        </div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        <span class="comment">! locals</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1score__type.html">score_type</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>:: new_ascore(:)        <span class="comment">! tmp pointer</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;        </div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;        nscores = nscores +1</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="keywordflow">if</span>(nscores&gt;maxscores) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;                maxscores = maxscores + 16              <span class="comment">! allocate 16 elements a time</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;                <span class="keyword">allocate</span>(new_ascore(maxscores)) <span class="comment">! allocate new mem</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                new_ascore(1:nscores-1) = ascore(1:nscores-1)   <span class="comment">! copy old</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;                </div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;                <span class="keyword">deallocate</span>(ascore)                              <span class="comment">! return old mem to OS</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;                ascore =&gt; new_ascore                            <span class="comment">! update pointer</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        <span class="comment">! finally store values</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;        ascore(nscores)%frame           = iframe        <span class="comment">! iFrame may be redundant</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        ascore(nscores)%score           = score</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;        ascore(nscores)%h_bonds         = hbond_term</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        ascore(nscores)%metal           = metal_term</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        ascore(nscores)%lipophil        = lipo_term</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;        ascore(nscores)%rot_bond        = rot_term</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#ac981dadd7632147eefe3240bada21d79">log_frame</a></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        </div>
<div class="line"><a name="l00210"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a281f50164f92a72afef6055495578adb">  210</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a281f50164f92a72afef6055495578adb">score_heading</a>(i)</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        <span class="keywordtype">integer</span>         ::      i</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        <span class="keyword">write</span>(*,100)  <span class="stringliteral">&#39;score&#39;</span>, <span class="stringliteral">&#39;h-bonds&#39;</span>, <span class="stringliteral">&#39;metal&#39;</span>, <span class="stringliteral">&#39;lipophilic&#39;</span>, <span class="stringliteral">&#39;rot_bond&#39;</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;100     <span class="keyword">format</span>(        t29,a5,  t38,a7,    t51,a5,  t58,a10,       t71,a8)</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">!       write(*,&#39;(a)&#39;, advance=&#39;no&#39;) &#39;SCORE&#39;</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a281f50164f92a72afef6055495578adb">score_heading</a></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ac93b5a3a788abe9cc8dc2e98dc9c50bc">  219</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#ac93b5a3a788abe9cc8dc2e98dc9c50bc">calc_hbonds</a>            <span class="comment">!in subroutine calc_scores</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;        <span class="keywordtype">integer</span>         :: i,j</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="keywordtype">real</span>                    :: score1,score2</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        hbond_term = 0</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;        <span class="keywordflow">do</span> i = 1,nhbd_l                                                                                                                                                 <span class="comment">!ligand h-bond donors scored against</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;                <span class="keywordflow">do</span> j = 1,nhba_r                                                                                                                                         <span class="comment">!receptor acceptors</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;                        score1 = <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a>(hbd_l(i)%hydr,hba_r(j))                                  <span class="comment">!distance term</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;                        score2 = <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a>(hbd_l(i)%heavy,hbd_l(i)%hydr,hba_r(j))   <span class="comment">!angle term</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;                        hbond_term = hbond_term+score1*score2</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        </div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keywordflow">do</span> i = 1,nhba_l                                                                                                                                                 <span class="comment">!ligand acceptors scored against</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                <span class="keywordflow">do</span> j = 1,nhbd_r                                                                                                                                         <span class="comment">!receptor donors</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                        score1 = <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a>(hba_l(i),hbd_r(j)%hydr)</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                        score2 = <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a>(hba_l(i),hbd_r(j)%hydr,hbd_r(j)%heavy)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;                        hbond_term = hbond_term+score1*score2</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#ac93b5a3a788abe9cc8dc2e98dc9c50bc">calc_hbonds</a></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a6b8b6af53a8f99ef2db73dd097e88729">  243</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a6b8b6af53a8f99ef2db73dd097e88729">calc_lipo</a>                            <span class="comment">!in subroutine calc_scores</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="keywordtype">integer</span>                                 ::i,j   </div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordtype">real</span>                                    ::fij</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        lipo_term = 0</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        <span class="keywordflow">do</span> i = 1,nlph_l                                                         <span class="comment">!lipophilic atoms in ligand</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                <span class="keywordflow">do</span> j = 1,nlph_r                                                 <span class="comment">!    &#39;&#39;              receptor</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                        fij = <a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000">fr_lip</a>(lph_l(i),lph_r(j))</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;                        lipo_term = lipo_term+fij</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a6b8b6af53a8f99ef2db73dd097e88729">calc_lipo</a></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div>
<div class="line"><a name="l00258"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a6755b67dc877c9ed91725640f577d272">  258</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a6755b67dc877c9ed91725640f577d272">calc_metals</a>                          <span class="comment">!in subroutine calc_scores</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;        <span class="keywordtype">integer</span>                 :: i,j</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="keywordtype">real</span>                            :: score</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        metal_term = 0</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="keywordflow">do</span> i = 1,nmet_r                                                                                         <span class="comment">!metal atoms in receptor</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;                <span class="keywordflow">do</span> j = 1,nhba_l                                                                                 <span class="comment">!H-bond acceptors in ligand             </span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;                        score = <a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59">fr_met</a>(met_r(i),hba_l(j))</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;                        metal_term = metal_term+score</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a6755b67dc877c9ed91725640f577d272">calc_metals</a></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div>
<div class="line"><a name="l00272"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#af574f7169a6f5779bb0f7b26b3377e81">  272</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#af574f7169a6f5779bb0f7b26b3377e81">calc_rot</a>                                     <span class="comment">!in subroutine calc_scores</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;        <span class="keywordtype">integer</span>                 :: i,nfrozen</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;        <span class="keywordtype">real</span>                            :: pa,pb,hrot,sum</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;        </div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        nfrozen = 0</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        sum = 0</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <span class="keywordflow">do</span> i = 1,nqbonds</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                <span class="keywordflow">if</span> (q_bonds(i)%acontact .and. q_bonds(i)%bcontact) <span class="keywordflow">then</span>  <span class="comment">!if the bond is rotatable and frozen</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;                                nfrozen = nfrozen + 1</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;                                pa = <span class="keywordtype">real</span>(q_bonds(i)%a_nonlip)/(q_bonds(i)%a_nonlip + q_bonds(i)%a_lip) <span class="comment">! % non-lipophilic heavy atoms on a-side</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;                                pb = <span class="keywordtype">real</span>(q_bonds(i)%b_nonlip)/(q_bonds(i)%b_nonlip + q_bonds(i)%b_lip)</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;                                sum = sum + ((pa + pb)/2)               <span class="comment">!add to sum with weight according to pa and pb</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;                                <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;qbond &#39;</span>, i, <span class="stringliteral">&#39;, atoms &#39;</span>, q_bonds(i)%a%top_nr, q_bonds(i)%b%top_nr, <span class="stringliteral">&#39;, contrib = &#39;</span>, ((pa + pb)/2)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        <span class="keywordflow">if</span>(nfrozen == 0) <span class="keywordflow">then</span> </div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                hrot = 0                                        </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;                hrot = 1 + (1-1.0/nfrozen)*sum</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        rot_term = hrot</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#af574f7169a6f5779bb0f7b26b3377e81">calc_rot</a></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ac685deaa80ea9769e36c6b9ac8c8462d">  297</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#ac685deaa80ea9769e36c6b9ac8c8462d">calc_scores</a></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a81ef9a983f650189ae781ea35f2d2699">set_waters</a>                         <span class="comment">! does calcs on waters</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;        call <a class="code" href="classcalc__chemscore.html#ac93b5a3a788abe9cc8dc2e98dc9c50bc">calc_hbonds</a>                        <span class="comment">! calc contribution from hbond interaction between ligand and receptor</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;        </div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a6755b67dc877c9ed91725640f577d272">calc_metals</a>                        <span class="comment">! calc contrib from metals in rec interacting with h-bond acceptors in ligand</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;        </div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a6b8b6af53a8f99ef2db73dd097e88729">calc_lipo</a>                          <span class="comment">! calc lipophilic contrib</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a92a6bfaa5082d7b7d825e44c40226307">q_contacts</a>                         <span class="comment">! set contact parameter =.true. for qatoms in contact with receptor</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a69331a1a41dd3b2dd7c69f272d87ebc5">frozen</a>                                             <span class="comment">! checks if rotatable bonds are frozen</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;        call <a class="code" href="classcalc__chemscore.html#af574f7169a6f5779bb0f7b26b3377e81">calc_rot</a>                                   <span class="comment">! calcs contrib from frozen rotatable bonds</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#ac685deaa80ea9769e36c6b9ac8c8462d">calc_scores</a></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div>
<div class="line"><a name="l00310"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#afa2b8e0f000132f3f983c3781cc16115">  310</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#afa2b8e0f000132f3f983c3781cc16115">count_qlipo</a>          </div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        <span class="comment">!count (non)lipophilic heavy atoms on each side of every bond</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="keywordtype">integer</span>                                 ::      i</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1lipos.html">lipos</a><span class="keywordtype">)</span>                             ::      lipo</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;        q_bonds(:)%a_lip = 0            <span class="comment">!reset</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        q_bonds(:)%b_lip = 0</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        q_bonds(:)%a_nonlip = 0</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        q_bonds(:)%b_nonlip = 0</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        <span class="keywordflow">do</span> i = 1,nqbonds </div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                <span class="keywordflow">if</span> (q_bonds(i)%rotatable) <span class="keywordflow">then</span>                  <span class="comment">!go through all rotatable bonds</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;                        q_bonds(:)%been_there = .false.</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;                        q_atoms(:)%been_there = .false.         <span class="comment">!reset</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;                        q_bonds(i)%been_there = .true.</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;                        lipo = <a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">lip_atom</a>(q_bonds(i)%a)           <span class="comment">!lip_atom recursively counts heavy atoms on a-side</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                        q_bonds(i)%a_lip = lipo%n_lip</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                        q_bonds(i)%a_nonlip = lipo%n_nonlip</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                        lipo = <a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">lip_atom</a>(q_bonds(i)%b)           <span class="comment">!on b-side</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                        q_bonds(i)%b_lip = lipo%n_lip</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                        q_bonds(i)%b_nonlip = lipo%n_nonlip</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#afa2b8e0f000132f3f983c3781cc16115">count_qlipo</a></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div>
<div class="line"><a name="l00337"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">  337</a></span>&#160;<span class="keyword">recursive function </span><a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">lip_atom</a>(atom) result(ans)</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">!arguments</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>                    ::      atom</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;                </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="comment">!local</span></div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1lipos.html">lipos</a><span class="keywordtype">)</span>                                             ::  lipo</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1lipos.html">lipos</a><span class="keywordtype">)</span>                                             ::      temp</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        <span class="keywordtype">integer</span>                                                 ::      i</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>                    ::      <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1lipos.html">lipos</a><span class="keywordtype">)</span>                                             ::  ans</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        lipo%n_lip = 0</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        lipo%n_nonlip = 0</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        atom%been_there = .true.                                        <span class="comment">!flag to avoid cycling in rings</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        <span class="keywordflow">do</span> i = 1,atom%n                                                         <span class="comment">!go through every bond to this atom</span></div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a> =&gt; atom%bd(i)%qb                                                   </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;                <span class="keywordflow">if</span> ( .not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there ) <span class="keywordflow">then</span>               <span class="comment">!if the bond has not already been passed</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;                        temp%n_lip = 0</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;                        temp%n_nonlip = 0</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;                        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there = .true.</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;                                                                                                <span class="comment">!count heavy atoms on the opposite side</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;                        <span class="keywordflow">if</span> (.not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%been_there ) <span class="keywordflow">then</span>      <span class="comment">!i.e. the side with an atom which has not been passed</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;                                temp = <a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">lip_atom</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a)                 </div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;                        <span class="keywordflow">if</span> (.not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b%been_there ) <span class="keywordflow">then</span> </div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;                                temp = <a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">lip_atom</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b)</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;                        <span class="keywordflow">end if</span>  </div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        </div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;                        lipo%n_lip = lipo%n_lip+temp%n_lip  <span class="comment">!add result from each bond</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;                        lipo%n_nonlip = lipo%n_nonlip+temp%n_nonlip</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;        </div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;        <span class="keywordflow">if</span> (atom%at_type == 2) <span class="keywordflow">then</span>                                     <span class="comment">!add atom itself to sum</span></div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                lipo%n_lip = lipo%n_lip + 1</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;        <span class="keywordflow">if</span> (atom%at_type == 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;                lipo%n_nonlip = lipo%n_nonlip + 1</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;        ans = lipo                                                                      <span class="comment">!return result to atom which made the call</span></div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a8c71c15529a582f52f4d152db39e0704">lip_atom</a></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;                </div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a69331a1a41dd3b2dd7c69f272d87ebc5">  381</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a69331a1a41dd3b2dd7c69f272d87ebc5">frozen</a></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        <span class="comment">! check each rotatable bond to see if it is frozen</span></div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        <span class="keywordtype">integer</span>                                 ::      i,j</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>    ::      <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>    ::      atom</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;        q_bonds(:)%acontact = .false.   <span class="comment">!reset</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        q_bonds(:)%bcontact = .false.</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                                </div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;        <span class="keywordflow">do</span> i = 1,nqbonds                                                                                <span class="comment">! go through all bonds</span></div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a> =&gt; q_bonds(i)                                                              <span class="comment">! pointer to bond i</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%rotatable) <span class="keywordflow">then</span>                                        <span class="comment">! only have to check rotatable bonds</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                        q_bonds(:)%been_there = .false. <span class="comment">! reset</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                        q_atoms(:)%been_there = .false.</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                        </div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there = .true.</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%acontact = <a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">find_contact</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a)    <span class="comment">!if any contacts on a-side of rotatable bond</span></div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%bcontact = <a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">find_contact</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b)    <span class="comment">!if any contacts on b-side</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a69331a1a41dd3b2dd7c69f272d87ebc5">frozen</a></div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div>
<div class="line"><a name="l00403"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">  403</a></span>&#160;<span class="keyword">recursive function </span><a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">find_contact</a>(atom) result(ans)       </div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">!argument</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>    :: atom</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">!local</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordtype">integer</span>                                 ::      i</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        <span class="keywordtype">logical</span>                                 ::      cont</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>    ::      <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a></div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        <span class="keywordtype">logical</span>                                 ::      ans</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        cont = .false.                                          <span class="comment">!no contact found yet</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;        atom%been_there = .true.</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;        <span class="keywordflow">if</span> (atom%contact) <span class="keywordflow">then</span>                          <span class="comment">!if this atom is in contact there is no need to keep looking</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;                cont = .true.</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;        <span class="keywordflow">else</span>                                                            <span class="comment">!else go through all the bonds to this atom which have not been passed yet</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                <span class="keywordflow">do</span> i = 1,atom%n </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;                        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a> =&gt; atom%bd(i)%qb   </div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;                        <span class="keywordflow">if</span> ( .not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;                                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there = .true.</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;                                <span class="keywordflow">if</span> ( .not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%been_there ) <span class="keywordflow">then</span>             <span class="comment">!if not passed atom a (call came from atom b)</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;                                        cont = <a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">find_contact</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a)                     <span class="comment">!check if contact on this side</span></div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( .not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b%been_there ) <span class="keywordflow">then</span>                <span class="comment">!if call came from atom a</span></div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                                        cont = <a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">find_contact</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b)                     <span class="comment">!check b-side</span></div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                                <span class="keywordflow">if</span> (cont) <span class="keywordflow">then</span>                                                  <span class="comment">!if contact found on other side of bond</span></div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;                                        <span class="keywordflow">exit</span>                                                            <span class="comment">!no need to keep looking</span></div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        ans = cont                                                                                      <span class="comment">!return result to atom which made the call</span></div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a95aa01634744dda8ac3af377750a6de1">find_contact</a></div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div>
<div class="line"><a name="l00440"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a4f53ad3d13e7c23d47c94a6a882e6bd8">  440</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a4f53ad3d13e7c23d47c94a6a882e6bd8">get_atom_data</a></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="comment">!---------------- Local variables -----------------!</span></div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="keywordtype">integer</span>                                         ::      i, j</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;        <span class="keywordtype">real</span>                                            ::      rad(natyps)</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        <span class="keywordtype">real</span>                                            ::      radius</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;        <span class="keywordtype">logical</span>                                         ::      stat</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        <span class="keywordtype">logical</span>                                         ::      novdw(natyps)</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        <span class="keywordtype">character(len=8)</span>                        ::      tac_in</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        <span class="comment">!--------------------------------------------------!</span></div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="keyword">write</span>(*,<span class="stringliteral">&#39;(a,a)&#39;</span>) <span class="stringliteral">&#39;Reading atom parameters from &#39;</span>, trim(adjustl(atom_data_file))</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;        <span class="keyword">allocate</span>(atom_data(natyps))</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;        <span class="keywordflow">do</span> i = 1, natyps</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                atom_data(i)%radius = 0.</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;                atom_data(i)%prop(:) = .false.</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        <span class="keywordflow">if</span>(.not. <a class="code" href="classprmfile.html#a1507dcebf8d6f53a6493b1e63d9c9387">prm_open_section</a>(<span class="stringliteral">&#39;vdw_radii&#39;</span>, atom_data_file)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                <span class="keyword">write</span>(*,*) <span class="stringliteral">&#39;get_atom_data:: Failed to open vdw_radii section of parameter file &#39;</span>, trim(atom_data_file)</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;                stop <span class="stringliteral">&#39;Parameter file read failure&#39;</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        novdw(:) = .false.</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        <span class="keyword">allocate</span>(vdwr(1:nat_solute))</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">do</span> <span class="keywordflow">while</span>(<a class="code" href="classprmfile.html#a7d278e2532151a89967338fcbe5330dd">prm_get_string_real</a>(tac_in, radius))           <span class="comment">! tac_in and radius are returned</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;                <span class="keywordflow">if</span>(.not. <a class="code" href="classindexer.html#a3b93040983a622421fa918a6af566c93">index_get</a>(tac_in, i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">!                       write(*,10) trim(tac_in)</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;10                      <span class="keyword">format</span>(<span class="stringliteral">&#39;&gt;&gt;&gt; WARNING: Atom type &#39;</span>,a,<span class="stringliteral">&#39; ignored: not in topology.&#39;</span>)</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;                        atom_data(i)%radius = radius</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        </div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        <span class="keywordflow">do</span> i = 1,nat_solute                     <span class="comment">!!! Go through all atoms and give them a vdW radius.</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;                vdwr(i) = atom_data(iac(i))%radius      <span class="comment">!!! I represents atom number. </span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;                <span class="keywordflow">if</span> (vdwr(i) == 0.0) novdw(iac(i)) = .true.              </div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        <span class="keywordflow">do</span> i = 1, natyps</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;                <span class="keywordflow">if</span> (novdw(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;                        <span class="keyword">write</span>(*,20) tac(i)</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;                        warn = warn +1</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;20              <span class="keyword">format</span>(<span class="stringliteral">&#39;WARNING: No vdW radius designated to atom type &#39;</span>, a)</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;        <span class="comment">!read atom type categories</span></div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        <span class="keywordflow">do</span> j = 1, nprops</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;                <span class="keywordflow">if</span>(.not. <a class="code" href="classprmfile.html#a1507dcebf8d6f53a6493b1e63d9c9387">prm_open_section</a>(file_heading(j))) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;                        <span class="keyword">write</span>(*,30) file_heading(j)</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;30                      <span class="keyword">format</span>(<span class="stringliteral">&#39;Failed to open &#39;</span>,a,<span class="stringliteral">&#39; section of parameter file.&#39;</span>)</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;                        stop <span class="stringliteral">&#39;Parameter file read failure&#39;</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;                <span class="keywordflow">do</span> <span class="keywordflow">while</span>(<a class="code" href="classprmfile.html#a36840b95034f748e9cd891b86649f690">prm_get_line</a>(tac_in))</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;                        <span class="keywordflow">if</span>(.not. <a class="code" href="classindexer.html#a3b93040983a622421fa918a6af566c93">index_get</a>(tac_in, i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">!                               write(*,10) trim(tac_in)</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;                                atom_data(i)%prop(j) = .true.</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a4f53ad3d13e7c23d47c94a6a882e6bd8">get_atom_data</a></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div>
<div class="line"><a name="l00506"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a4bb62e49849feeae28e33973facd130e">  506</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a4bb62e49849feeae28e33973facd130e">make_tac_index</a></div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="comment">! creates index of atom types   </span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordtype">integer</span>         ::      i</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;        call <a class="code" href="classindexer.html#aa83f2bc15a2dfefd22f4fe96975fd213">index_create</a>(natyps)               <span class="comment">! natyps is read from file</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="keywordflow">do</span> i = 1, natyps</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                <span class="keywordflow">if</span>(.not. <a class="code" href="classindexer.html#a3881b2e3e31c5a3e188e90ad8bc96405">index_add</a>(tac(i), i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;                        stop <span class="stringliteral">&#39;&gt;&gt;&gt;&gt;&gt; ERROR: Could not make atom type index&#39;</span></div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a4bb62e49849feeae28e33973facd130e">make_tac_index</a></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a92a6bfaa5082d7b7d825e44c40226307">  518</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a92a6bfaa5082d7b7d825e44c40226307">q_contacts</a>           </div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        <span class="comment">!check which q-atoms are in contact with receptor, in subroutine calc_scores</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        <span class="keywordtype">integer</span>                         ::      i,j,tnr</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordtype">real</span>                                    ::      <a class="code" href="classcalc__xscore.html#a9549d00bc3dbc987d9161e831a433493">distance</a></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        </div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        q_atoms(:)%contact = .false.</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        <span class="keywordflow">do</span> i = 1,nqat                                                                                                                                                                                   <span class="comment">! loop over heavy q-atoms</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;                tnr = q_atoms(i)%top_nr</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;                <span class="keywordflow">if</span> (heavy(tnr)) <span class="keywordflow">then</span>                                                                                                                                            <span class="comment">! if heavy </span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;                        <span class="keywordflow">do</span> j = 1,nat_solute                                                                                                                                             <span class="comment">! all protein atoms, not the waters</span></div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;                                <span class="keywordflow">if</span> ((iqatom(j) == 0) .and. (heavy(j)) ) <span class="keywordflow">then</span>                            <span class="comment">! if heavy receptor atom (not q-atom)</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;                                        <a class="code" href="classcalc__xscore.html#a9549d00bc3dbc987d9161e831a433493">distance</a> = <a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a>(tnr,j)                                                                                                          <span class="comment">! measure distance</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;                                        <span class="keywordflow">if</span> (<a class="code" href="classcalc__xscore.html#a9549d00bc3dbc987d9161e831a433493">distance</a> &lt;= ( vdwr(tnr)+vdwr(j)+0.5 )) <span class="keywordflow">then</span>         <span class="comment">! if distance &lt; vdw1+vdw2+0.5</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;                                                q_atoms(i)%contact = .true.                                                                                     <span class="comment">! then contact</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;                                                <span class="keywordflow">exit</span>            <span class="comment">!no need to keep looking once one contact has been found</span></div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;                                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;                        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a92a6bfaa5082d7b7d825e44c40226307">q_contacts</a></div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div>
<div class="line"><a name="l00541"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a2e6ad5279a8abd4f97d64943f783bc61">  541</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a2e6ad5279a8abd4f97d64943f783bc61">q_types</a>                      </div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;        <span class="comment">! assign q-atom types and hybrids, used in entropy</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="comment">! calculation, in subroutine set_ligand</span></div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;        <span class="keywordtype">integer</span>                                         ::      i,nr, a_type</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        <span class="comment">!set atom type 0:hydrogen, 2:heavy lipophilic, 1:non-lipophilic heavy   </span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        <span class="keywordflow">do</span> i = 1,nqat</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;                nr = iqseq(i)                                                                           <span class="comment">! topology number</span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;                q_atoms(i)%top_nr = nr                                  <span class="comment">! used in other subroutines</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                a_type = iac(nr)</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                <span class="keywordflow">if</span>(atom_data(a_type)%prop(lipo)) <span class="keywordflow">then</span> <span class="comment">!all C, P, F</span></div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;                        <span class="keywordflow">if</span> (pol_con(nr) &lt; 2)    <span class="keywordflow">then</span>    <span class="comment">!if carbons have &gt;=2 polar connections then it is polar, 62 always have 0</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;                                q_atoms(i)%at_type = 2          <span class="comment">!lipophilic</span></div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;                                q_atoms(i)%at_type = 1          <span class="comment">!non-lipophilic</span></div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(sulphur)) <span class="keywordflow">then</span>    <span class="comment">!sulphur</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;                        <span class="keywordflow">if</span> (pol_con(nr) &lt; 1) <span class="keywordflow">then</span>               <span class="comment">!which is not attached to any polar atom</span></div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;                                q_atoms(i)%at_type = 2          <span class="comment">!is lipophilic</span></div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;                                q_atoms(i)%at_type = 1</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                <span class="keywordflow">elseif</span>(iaclib(a_type)%mass &lt; 4.) <span class="keywordflow">then</span> <span class="comment">!hydrogen</span></div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;                        q_atoms(i)%at_type = 0                  <span class="comment">!not heavy</span></div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;                <span class="keywordflow">else</span>                                            <span class="comment">!all others are non-lipophilic heavy</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                                q_atoms(i)%at_type = 1</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;                <span class="comment">!set hybridization</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                <span class="keywordflow">if</span>(atom_data(a_type)%prop(sp3)) <span class="keywordflow">then</span> <span class="comment">!sp3</span></div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                        q_atoms(i)%hybrid = 3</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(sp3_n)) <span class="keywordflow">then</span> <span class="comment">!sp3 nitrogens</span></div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                        <span class="keywordflow">if</span> (pol_con(nr) == 21 .or. pol_con(nr) == 31) <span class="keywordflow">then</span>      <span class="comment">!if bonded to two H and one other, or three H and one other</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;                                q_atoms(i)%hybrid = 0                                                   <span class="comment">!then terminal NH2 or NH3 and should not be included    </span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                                q_atoms(i)%hybrid = 3   </div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                        <span class="keywordflow">end if</span> </div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(sp2)) <span class="keywordflow">then</span> <span class="comment">!sp2</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                        q_atoms(i)%hybrid = 2</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(pl_n)) <span class="keywordflow">then</span> <span class="comment">!planar nitrogens</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;                        <span class="keywordflow">if</span> (pol_con(nr) == 21 ) <span class="keywordflow">then</span>    <span class="comment">!if bonded to two H and one other then terminal NH2 and not included</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;                                q_atoms(i)%hybrid = 0</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                                q_atoms(i)%hybrid = 2   </div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                        <span class="keywordflow">end if</span> </div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                        q_atoms(i)%hybrid = 0</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a2e6ad5279a8abd4f97d64943f783bc61">q_types</a></div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;              </div>
<div class="line"><a name="l00595"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a01a080b62749ee18b509448a22380c13">  595</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a01a080b62749ee18b509448a22380c13">report_ligand</a></div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;        <span class="keywordtype">integer</span>                                 ::i,top,cont</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;        <span class="keyword">write</span>(*,100) <span class="stringliteral">&#39;#&#39;</span>,  <span class="stringliteral">&#39;atom&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;hybrid&#39;</span>, <span class="stringliteral">&#39;type&#39;</span>, <span class="stringliteral">&#39;bonds&#39;</span>, <span class="stringliteral">&#39;contact&#39;</span></div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;        100     <span class="keyword">format</span>(   t8,a, t14,a,  t23,a,  t35,a,    t48,a,  t58,a,   t67,a)</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;        <span class="keywordflow">do</span> i = 1,nqat</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                top = q_atoms(i)%top_nr</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;                <span class="keywordflow">if</span> (q_atoms(i)%contact) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;                        cont = 1</div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;                        cont = 0</div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;                110     <span class="keyword">format</span>(t1,i8, t10,i8, t23,a8, t33,i8, t45,i8, t55,i8, t66,i8)</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="comment">!               110     format((1x,i8), t9,(1x,i8), t18,(1x,a8), t27,(1x,i8), t36,(1x,i8), t45,(1x,i8), t54,(1x,i8))</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="comment">!               110 format(2(1x,i8),1x,a8,4(1x,i8))</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment">!               110 format(7i8)</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        </div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;                <span class="keyword">write</span>(*, 110) i, top, tac(iac(top)), q_atoms(i)%hybrid, q_atoms(i)%at_type, q_atoms(i)%n, cont</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="comment">!               write(*, 110) i, top, iac(top), q_atoms(i)%hybrid, q_atoms(i)%at_type, q_atoms(i)%n, cont</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        <span class="keyword">write</span>(*,120) <span class="stringliteral">&#39;lipophilic&#39;</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;        120 <span class="keyword">format</span>(1a11)</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;        130 <span class="keyword">format</span>(1i7)</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;        140 <span class="keyword">format</span>(2i7)</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;        <span class="keywordflow">do</span> i = 1,nlph_l </div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;                <span class="keyword">write</span>(*,130) lph_l(i)</div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        <span class="keyword">write</span>(*,120) <span class="stringliteral">&#39;Hb acc&#39;</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        <span class="keywordflow">do</span> i = 1,nhba_l</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                <span class="keyword">write</span>(*,130) hba_l(i)</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="keyword">write</span>(*,120) <span class="stringliteral">&#39;Hb don&#39;</span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;        <span class="keywordflow">do</span> i = 1,nhbd_l</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                <span class="keyword">write</span>(*,140) hbd_l(i)%heavy, hbd_l(i)%hydr</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a01a080b62749ee18b509448a22380c13">report_ligand</a>    </div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;</div>
<div class="line"><a name="l00634"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#af79fd6a521299e01b74e8d9ec1c113fe">  634</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#af79fd6a521299e01b74e8d9ec1c113fe">report_protein</a></div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;100     <span class="keyword">format</span>(<span class="stringliteral">&#39;# Receptor atom summary:&#39;</span>)</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;110     <span class="keyword">format</span>(<span class="stringliteral">&#39;# &#39;</span>,a,t20,i6)</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;        <span class="keyword">write</span>(*,100)</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;total&#39;</span>, nat_pro-nqat</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;lipophilic&#39;</span>, nlph_r</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;H-bond donors&#39;</span>, nhbd_r</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;H-bond acceptors&#39;</span>, nhba_r</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;metal ions&#39;</span>, nmet_r</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;water molecules&#39;</span>, nwaters</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;        <span class="keyword">write</span>(*,*)</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#af79fd6a521299e01b74e8d9ec1c113fe">report_protein</a>           </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div>
<div class="line"><a name="l00648"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a96f372948049119e39d151b115758321">  648</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a96f372948049119e39d151b115758321">report_rings</a></div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;        <span class="keywordtype">integer</span>                                 ::i,j</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;        <span class="keyword">write</span> (*,<span class="stringliteral">&#39;(/,a,I3)&#39;</span>) <span class="stringliteral">&#39;number of rings = &#39;</span>,nrings</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;        <span class="keywordflow">do</span> i = 1,nrings</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                <span class="keyword">write</span> (*,<span class="stringliteral">&#39;(a,I3,a)&#39;</span>) <span class="stringliteral">&#39;ring &#39;</span>,i,<span class="stringliteral">&#39;: &#39;</span></div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                        <span class="keywordflow">do</span> j = 1,nqbonds</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                                <span class="keywordflow">if</span> (q_bonds(j)%cyclic(i)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                                        <span class="keyword">write</span> (*,<span class="stringliteral">&#39;(I5,a,I5)&#39;</span>) q_bonds(j)%a%top_nr,<span class="stringliteral">&#39; &#39;</span>,q_bonds(j)%b%top_nr</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a96f372948049119e39d151b115758321">report_rings</a></div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;</div>
<div class="line"><a name="l00664"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a8b10ac4feeec194f53ba62db0a28cd6c">  664</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a8b10ac4feeec194f53ba62db0a28cd6c">reset_waters</a> <span class="comment">!in subroutine set_waters</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;                nhbd_r = nhbd_prot</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;                nhba_r = nhba_prot</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a8b10ac4feeec194f53ba62db0a28cd6c">reset_waters</a></div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;                </div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;                        </div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;</div>
<div class="line"><a name="l00672"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#acdc0c2f07cc5b0046e6fa9acf7cbfa20">  672</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#acdc0c2f07cc5b0046e6fa9acf7cbfa20">score_waters</a></div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;        <span class="comment">!calculate hydrogen bonds between each water molecule and receptor !in set_waters</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;        <span class="keywordtype">integer</span>                         ::i,j,k</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;        <span class="keywordtype">real</span>                                    ::score1,score2, sum_score</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;        <span class="keywordflow">do</span> i = 1,nwaters</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;                sum_score = 0.0</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;                </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;                <span class="keywordflow">do</span> j = 1,nhba_r                                                         <span class="comment">!water hydrogens as donors, scored against receptor acceptors</span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;                        score1 = <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a>(waters(i)%H1,hba_r(j))                           <span class="comment">!distance term</span></div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;                        score2 = <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a>(waters(i)%O,waters(i)%H1,hba_r(j))       <span class="comment">!angle term</span></div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;                        sum_score = sum_score+score1*score2</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;                        score1 = <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a>(waters(i)%H2,hba_r(j))</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;                        score2 = <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a>(waters(i)%O,waters(i)%H2,hba_r(j))       </div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;                        sum_score = sum_score+score1*score2</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;                <span class="keywordflow">do</span> j = 1,nhbd_r         <span class="comment">!water oxygen as acceptor, scored against receptor donors</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;                        score1 = <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a>(waters(i)%O,hbd_r(j)%hydr)</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;                        score2 = <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a>(waters(i)%O,hbd_r(j)%hydr,hbd_r(j)%heavy)        </div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;                        sum_score = sum_score+score1*score2</div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;                waters(i)%score = sum_score</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#acdc0c2f07cc5b0046e6fa9acf7cbfa20">score_waters</a></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div>
<div class="line"><a name="l00700"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a1a0ba4ea42a592ed4c0017e204372e0b">  700</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a1a0ba4ea42a592ed4c0017e204372e0b">set_ligand</a></div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a2e6ad5279a8abd4f97d64943f783bc61">q_types</a>                            <span class="comment">! assign vdw radii to qatoms</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        call <a class="code" href="classcalc__chemscore.html#ace212f3ac54af67d6c9b4219bcfe2f54">set_rings</a>                  <span class="comment">! detect rings</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a83a9746853c3430bcb4548f1e5c88b90">set_rotatable</a>      <span class="comment">! set parameter &#39;rotatable&#39; to apropriate value</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        call <a class="code" href="classcalc__chemscore.html#afa2b8e0f000132f3f983c3781cc16115">count_qlipo</a>                <span class="comment">! count (non)lipophilic heavy atoms on each side of every bond</span></div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a1a0ba4ea42a592ed4c0017e204372e0b">set_ligand</a></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div>
<div class="line"><a name="l00707"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ace212f3ac54af67d6c9b4219bcfe2f54">  707</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#ace212f3ac54af67d6c9b4219bcfe2f54">set_rings</a>            <span class="comment">!in set_ligand</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;        </div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="keywordtype">integer</span>                                 ::      ir</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>    ::      start_atom</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        <span class="keywordtype">integer</span>                                 ::      i,j</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;        nrings = nqbonds-nqat+1                                         <span class="comment">!number of rings in ligand</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;        <span class="keywordflow">if</span> (nrings &gt; 0) <span class="keywordflow">then</span>                                                    <span class="comment">!if at least one ring</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                <span class="keywordflow">do</span> i = 1,nqbonds </div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;                        <span class="keyword">allocate</span> (q_bonds(i)%cyclic(nrings))</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;                        <span class="keywordflow">do</span> j = 1,nrings</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;                                q_bonds(i)%cyclic(j) = .false.          <span class="comment">!reset  </span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;                        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;                <span class="keywordflow">do</span> i = 1,nqat</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;                        <span class="keyword">allocate</span> (q_atoms(i)%cyclic(nrings))</div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;                        <span class="keywordflow">do</span> j = 1,nrings</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;                                q_atoms(i)%cyclic(j) = .false.</div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;                        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;                </div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;                q_bonds(:)%been_there = .false.         <span class="comment">!reset</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;                q_atoms(:)%been_there = .false.</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;                start_atom =&gt; q_atoms(1)                        <span class="comment">!does not matter which q-atom search starts from</span></div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;                ir = 0                                                          </div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;                </div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;                start_atom%been_there = .true.</div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;                <span class="keywordflow">do</span> i = 1,start_atom%n                           <span class="comment">!go through all bonds of the start atom</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;                        <span class="keywordflow">if</span> (.not. start_atom%bd(i)%qb%been_there ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;                                call <a class="code" href="classcalc__chemscore.html#a52f0eaac7653260916cc115ae99209b1">search_ring</a>(start_atom%bd(i)%qb,ir)</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;                <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;                </div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#ace212f3ac54af67d6c9b4219bcfe2f54">set_rings</a></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;</div>
<div class="line"><a name="l00745"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a52f0eaac7653260916cc115ae99209b1">  745</a></span>&#160;<span class="keyword">recursive subroutine </span><a class="code" href="classcalc__chemscore.html#a52f0eaac7653260916cc115ae99209b1">search_ring</a>(bond,ir)       </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment">!arguments</span></div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>                    ::      <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a></div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        <span class="keywordtype">integer</span>                                                 ::      ir</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment">!local</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>                    ::      atom</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        <span class="keywordtype">integer</span>                                                 ::      i</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there = .true.</div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;        <span class="keywordflow">if</span> ( <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%been_there .and. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b%been_there ) <span class="keywordflow">then</span>   <span class="comment">!if both atoms of a bond have been passed, but not the bond </span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;                call <a class="code" href="classcalc__chemscore.html#a414b73e7646faa655654d38f811747f4">mark_ring</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>,ir)                                                         <span class="comment">!then a ring has been found. call mark_ring to find all the atoms of this ring</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;        </div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;        atom =&gt; <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a                                                                                  <span class="comment">!pekartilldelning</span></div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        <span class="keywordflow">if</span> (.not. atom%been_there ) <span class="keywordflow">then</span>                                                <span class="comment">!if atom a has not been passed                  </span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;                atom%been_there = .true.</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;                <span class="keywordflow">do</span> i = 1,atom%n                                                                         <span class="comment">!look for rings in all directions which have not been passed </span></div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;                        <span class="keywordflow">if</span> (.not. atom%bd(i)%qb%been_there ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                                call <a class="code" href="classcalc__chemscore.html#a52f0eaac7653260916cc115ae99209b1">search_ring</a>(atom%bd(i)%qb,ir)</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;                <span class="keywordflow">end do</span>  </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;        <span class="keywordflow">else</span> </div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;                atom =&gt; <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b                          </div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;                <span class="keywordflow">if</span> (.not. atom%been_there ) <span class="keywordflow">then</span>                                                <span class="comment">!if it is atom b which has not been passed      </span></div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;                        atom%been_there = .true.</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;                        <span class="keywordflow">do</span> i = 1,atom%n</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;                                <span class="keywordflow">if</span> (.not. atom%bd(i)%qb%been_there ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;                                        call <a class="code" href="classcalc__chemscore.html#a52f0eaac7653260916cc115ae99209b1">search_ring</a>(atom%bd(i)%qb,ir)</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;                        <span class="keywordflow">end do</span>  </div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a52f0eaac7653260916cc115ae99209b1">search_ring</a></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;</div>
<div class="line"><a name="l00779"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a414b73e7646faa655654d38f811747f4">  779</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a414b73e7646faa655654d38f811747f4">mark_ring</a>(bond,ir)   !identify atoms involved in rings</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="comment">!arguments</span></div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;                <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>            ::      <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>            <span class="comment">!starting bond</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;                <span class="keywordtype">integer</span>                                         ::      ir</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="comment">!local</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;                <span class="keywordtype">logical</span>                                         ::      found           <span class="comment">!not used for anything, but the function trace_ring returns a value</span></div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;                ir = ir+1                                                                       <span class="comment">!one more ring has been found</span></div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;                q_bonds(:)%active = .false.                                     <span class="comment">!reset</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;                q_atoms(:)%active = .false.     </div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%cyclic(ir) = .true.                                        <span class="comment">!this bond is part of the ring</span></div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%active = .true.                    </div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%cyclic(ir) = .true.                                      <span class="comment">!atom on a-side also part of the ring</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;                found = <a class="code" href="classcalc__chemscore.html#abfb55febeb0d91f6e19fc431c096e3d8">trace_ring</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b,ir)                           <span class="comment">!try to close ring starting at atom on b-side </span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a414b73e7646faa655654d38f811747f4">mark_ring</a></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;</div>
<div class="line"><a name="l00795"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#abfb55febeb0d91f6e19fc431c096e3d8">  795</a></span>&#160;<span class="keyword">recursive function </span><a class="code" href="classcalc__chemscore.html#abfb55febeb0d91f6e19fc431c096e3d8">trace_ring</a>(atom,ir) result(ans)</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;<span class="comment">!arguments</span></div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__atom.html">q_atom</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>                    ::      atom</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        <span class="keywordtype">integer</span>                                                 ::      ir</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;<span class="comment">!local  </span></div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;        <span class="keywordtype">integer</span>                                                 ::      i</div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        <span class="keywordtype">logical</span>                                                 ::      found</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordtype">type(</span><a class="code" href="structcalc__chemscore_1_1q__bond.html">q_bond</a><span class="keywordtype">)</span>,<span class="keywordtype">pointer</span>                    ::      <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a></div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <span class="keywordtype">logical</span>                                                 ::      ans</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        found = .false.</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        atom%active = .true.                                                    <span class="comment">!this atom has been passed trying to close the ring</span></div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        <span class="keywordflow">do</span> i = 1,atom%n </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a> =&gt; atom%bd(i)%qb                                           <span class="comment">!go through all bonds which could be part of the ring recently found (been_there)</span></div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;                <span class="keywordflow">if</span> (<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%been_there .and. (.not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%active)) <span class="keywordflow">then</span>     <span class="comment">!but have not been passed trying to close the ring (not active)</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;                        <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%active = .true.</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;                        <span class="keywordflow">if</span> ( <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%been_there .and. (.not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%active ))<span class="keywordflow">then</span>        <span class="comment">!a could be part of the ring, and have not checked it yet</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;                                <span class="keywordflow">if</span> ( <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a%cyclic(ir) ) <span class="keywordflow">then</span>                                                           <span class="comment">!if a is part of the right ring</span></div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;                                        found = .true.                                                                                  <span class="comment">!then the ring is closed</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;                                        found = <a class="code" href="classcalc__chemscore.html#abfb55febeb0d91f6e19fc431c096e3d8">trace_ring</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%a,ir)                                                   <span class="comment">!else look in a direction</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b%been_there .and. (.not. <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b%active ))<span class="keywordflow">then</span>   <span class="comment">!b could be part of the ring, and have not checked it yet</span></div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;                                <span class="keywordflow">if</span> ( <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b%cyclic(ir) ) <span class="keywordflow">then</span>                                                           <span class="comment">!if b part of the right ring</span></div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;                                        found = .true.                                                                                  <span class="comment">!ring closed</span></div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;                                        found = <a class="code" href="classcalc__chemscore.html#abfb55febeb0d91f6e19fc431c096e3d8">trace_ring</a>(<a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%b,ir)                                                   <span class="comment">!else look in b direction</span></div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;                        <span class="keywordflow">if</span> (found) <span class="keywordflow">then</span>                                 <span class="comment">!if possible to close ring using this bond</span></div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;                                <a class="code" href="classmd.html#a677ce4371ed79a4dd96c8ed2f3ab6956">bond</a>%cyclic(ir) = .true.        <span class="comment">!this bond is part of the ring</span></div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;                                                                                        <span class="comment">!if possible to close the ring using bond i</span></div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;                                atom%cyclic(ir) = .true.        <span class="comment">!then this atom is also part of the ring</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;                                <span class="keywordflow">exit</span>                                            <span class="comment">!no need to keep looking when ring closed</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;        </div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        ans = found                                                                                                     <span class="comment">!if possible to close ring using this atom</span></div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#abfb55febeb0d91f6e19fc431c096e3d8">trace_ring</a> </div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;</div>
<div class="line"><a name="l00837"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a83a9746853c3430bcb4548f1e5c88b90">  837</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a83a9746853c3430bcb4548f1e5c88b90">set_rotatable</a></div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <span class="comment">!check which q-bonds are rotatable</span></div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        <span class="keywordtype">integer</span>                                 :: i,j</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        q_bonds(:)%rotatable = .false.</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        <span class="keywordflow">do</span> i = 1,nqbonds                <span class="comment">!go through all qbonds, rotatable if sp2-sp3 or sp3-sp3</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;                <span class="keywordflow">if</span>  ( ( (q_bonds(i)%a%hybrid == 3) .and. (q_bonds(i)%b%hybrid &gt; 0) ) &amp;</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;                        .or. ( (q_bonds(i)%b%hybrid == 3) .and. (q_bonds(i)%a%hybrid &gt; 0) ) ) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;                        q_bonds(i)%rotatable = .true.</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;                        </div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;                        <span class="keywordflow">do</span> j = 1,nrings                 <span class="comment">!check if bond is member of any ring</span></div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;                                <span class="keywordflow">if</span> (q_bonds(i)%cyclic(j)) <span class="keywordflow">then</span>          <span class="comment">!then not rotatable</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;                                        q_bonds(i)%rotatable = .false.</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;                                        <span class="keywordflow">exit</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;                        <span class="keywordflow">end do</span>  </div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;</div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a83a9746853c3430bcb4548f1e5c88b90">set_rotatable</a></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div>
<div class="line"><a name="l00862"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a81ef9a983f650189ae781ea35f2d2699">  862</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a81ef9a983f650189ae781ea35f2d2699">set_waters</a>           <span class="comment">!in calc_scores</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a8b10ac4feeec194f53ba62db0a28cd6c">reset_waters</a>                       <span class="comment">! does some reseting of two ints</span></div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        call <a class="code" href="classcalc__chemscore.html#acdc0c2f07cc5b0046e6fa9acf7cbfa20">score_waters</a>                       <span class="comment">! calculate hydrogen bonds between each water molecule and receptor</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a340ee3d9ab3aefb6311490a3780ba4c8">sort_waters</a>                        <span class="comment">! does some calculation on the waters</span></div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a81ef9a983f650189ae781ea35f2d2699">set_waters</a></div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div>
<div class="line"><a name="l00869"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a5612ee8ef3d2f944d4d10d6fd62e86f0">  869</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a5612ee8ef3d2f944d4d10d6fd62e86f0">sort_atoms</a>           <span class="comment">!must be done after sort_bonds ,in subroutine start</span></div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;        <span class="keywordtype">integer</span>                                 ::i, a_type</div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;        </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;        <span class="keyword">allocate</span>(hba_l(nqat),lph_l(nqat),lph_r(nat_solute),hba_r(nat_solute),met_r(64))</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;        nlph_l = 0</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;        nlph_r = 0</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;        nmet_r = 0</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;        nhba_l = 0</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;        nhba_r = 0</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;        </div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;        </div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;        <span class="keywordflow">do</span> i = 1,nat_solute                             <span class="comment">!go through all atoms, put in right category    </span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;                a_type = iac(i)</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;                <span class="keywordflow">if</span>(atom_data(a_type)%prop(lipo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;                <span class="comment">!atoms which may be lipophilic: all carbons, Cl, Br, I which are not ions</span></div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;                        <span class="keywordflow">if</span> (pol_con(i) &lt; 2)     <span class="keywordflow">then</span>    <span class="comment">!If carbon has &gt;=2 polar connections then it is polar (not lipophilic), CL always included</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;                                <span class="keywordflow">if</span> (iqatom(i) /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;                                        nlph_l = nlph_l+1</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;                                        lph_l(nlph_l) = i</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;                                        nlph_r = nlph_r+1</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;                                        lph_r(nlph_r) = i</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(sulphur)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;                        <span class="comment">!sulphurs with more than one connection</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;                        <span class="keywordflow">if</span> (pol_con(i) &lt; 1) <span class="keywordflow">then</span>        <span class="comment">!which are not attached to a polar atom are lipophilic</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;                                <span class="keywordflow">if</span> (iqatom(i) /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;                                        nlph_l = nlph_l+1</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;                                        lph_l(nlph_l) = i</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;                                        nlph_r = nlph_r+1</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;                                        lph_r(nlph_r) = i</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(metal)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;                        <span class="comment">!all metal atoms</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;                                nmet_r = nmet_r+1                       <span class="comment">!only metals in receptor</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;                                met_r(nmet_r) = i</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;                        <span class="comment">! all N, all O, all halogen ions, sulphurs with only one </span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;                        <span class="comment">! connection can be Hbond acceptors             </span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;                        <span class="keywordflow">if</span> (pol_con(i) .le. 2) <span class="keywordflow">then</span>     <span class="comment">!If N has &gt;2 connections then it is polar, all other atoms have value 0</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;                                <span class="keywordflow">if</span> (iqatom(i) /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                                        nhba_l = nhba_l+1</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;                                        hba_l(nhba_l) = i</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;                                        nhba_r = nhba_r+1</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;                                        hba_r(nhba_r) = i</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;                                <span class="keywordflow">end if</span>                  </div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        nhba_prot = nhba_r</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a5612ee8ef3d2f944d4d10d6fd62e86f0">sort_atoms</a></div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div>
<div class="line"><a name="l00928"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a02f4a93c7e3a6a2621b7574617ce0775">  928</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a02f4a93c7e3a6a2621b7574617ce0775">sort_bonds</a>           <span class="comment">!identify pairs of atoms involved in q-bonds and/or hydrogen bonding !in start </span></div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        <span class="keywordtype">integer</span>                                         ::      atom1,atom2,hydrogen_atom</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        <span class="keywordtype">integer</span>                                         ::      heavy_at,a_type,type1,type2</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <span class="keywordtype">integer</span>                                         ::      i,j,k</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        <span class="keywordtype">logical</span>                                         ::      polar</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <span class="comment">!allokera listor</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        <span class="keyword">allocate</span> (q_atoms(nqat))</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        <span class="keyword">allocate</span> (q_bonds(nqat*2))              <span class="comment">! worst case?</span></div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        <span class="keyword">allocate</span> (hbd_r(nat_solute),hbd_l(nqat))</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        <span class="keyword">allocate</span> (pol_con(nat_solute))</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        nhbd_l = 0</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        nhbd_r = 0</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        q_atoms(:)%n = 0</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        nqbonds = 0</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        pol_con(:) = 0</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        <span class="keywordflow">do</span> i = 1,nbonds_solute          <span class="comment">! loop over all bonds between solute atoms</span></div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;                polar = .false. </div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;                atom1 = bnd(i)%i                </div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;                atom2 = bnd(i)%j</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;                </div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;                <span class="keywordflow">if</span>(atom_data(iac(atom1))%prop(hydrogen)) <span class="keywordflow">then</span>           <span class="comment">!all polar H    </span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;                        polar = .true.                          <span class="comment">!if one of the atoms is a polar hydrogen, then the bond is polar</span></div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;                        hydrogen_atom = atom1</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;                        heavy_at = atom2</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;                <span class="keywordflow">elseif</span>(atom_data(iac(atom2))%prop(hydrogen)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;                        polar = .true.</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;                        hydrogen_atom = atom2</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;                        heavy_at = atom1</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;                <span class="keywordflow">if</span> (polar) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;                        a_type = iac(heavy_at)                                  <span class="comment">!check if the bond matches any of the h-bond categories</span></div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;                        <span class="keywordflow">if</span>(atom_data(a_type)%prop(oxygen)) <span class="keywordflow">then</span> <span class="comment">!all oxygens (not water)        </span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;                                <span class="keywordflow">if</span> (iqatom(heavy_at) /= 0) <span class="keywordflow">then</span>         <span class="comment">!if q-atom</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;                                        nhbd_l = nhbd_l+1</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;                                        hbd_l(nhbd_l)%heavy = heavy_at  </div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                                        hbd_l(nhbd_l)%hydr = hydrogen_atom</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                                <span class="keywordflow">else</span>                                                            <span class="comment">!else receptor</span></div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;                                        nhbd_r = nhbd_r+1</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;                                        hbd_r(nhbd_r)%heavy = heavy_at          </div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;                                        hbd_r(nhbd_r)%hydr = hydrogen_atom</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(a_type)%prop(sp3_n) .or. &amp;</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;                                atom_data(a_type)%prop(pl_n)) <span class="keywordflow">then</span>              <span class="comment">!all nitrogens                  </span></div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;                                <span class="keywordflow">if</span> (iqatom(heavy_at) /= 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;                                        nhbd_l = nhbd_l+1</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                                        hbd_l(nhbd_l)%heavy = heavy_at          </div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                                        hbd_l(nhbd_l)%hydr = hydrogen_atom</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                                        nhbd_r = nhbd_r+1</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;                                        hbd_r(nhbd_r)%heavy = heavy_at          </div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;                                        hbd_r(nhbd_r)%hydr = hydrogen_atom</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;                                pol_con(heavy_at) = pol_con(heavy_at)+10                <span class="comment">!N bonded to H should not be included in hbond acceptors</span></div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;                <span class="keywordflow">else</span>                                                                            <span class="comment">!if not polar hydrogen, count connections to N,S and C</span></div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;                        type1 = iac(atom1)</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;                        type2 = iac(atom2)</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;                        <span class="keywordflow">if</span>(atom_data(type1)%prop(sp3_n) .or. &amp;</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                                atom_data(type1)%prop(pl_n)) <span class="keywordflow">then</span> <span class="comment">!all nitrogens</span></div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                                pol_con(atom1) = pol_con(atom1)+1               <span class="comment">!count all connections to N</span></div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(type1)%prop(carbon_lipo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;                                <span class="comment">!all carbons (except CH3 and carbons which might be in </span></div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;                                <span class="comment">!carbonyls or nitriles)</span></div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;                                <span class="keywordflow">if</span>(atom_data(type2)%prop(pl_n) .or. &amp;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;                                        atom_data(type2)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;                                        <span class="comment">!       case (30:37,40,41,43,44,49,51,52,61)    </span></div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;                                        <span class="comment">! all polar and H-bonding atoms (but not H, not C, not F) </span></div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;                                        <span class="comment">!i.e. all N, all O, all halogen ions, P, F, S with only one connection</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;                                        <span class="comment">!count polar connections to C</span></div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;                                        pol_con(atom1) = pol_con(atom1)+1       </div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(type1)%prop(sulphur)) <span class="keywordflow">then</span>     <span class="comment">!sulphur                                                </span></div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;                                <span class="comment">!count polar connections to S with more than one connection </span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;                                <span class="keywordflow">if</span>(atom_data(type2)%prop(pl_n) .or. &amp;</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;                                        atom_data(type2)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;                                        <span class="comment">!and not always bonded to a polar atom (49, sulphate, is always polar and no need to count)</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;                                        <span class="comment">!case (30:37,40,41,43,44,49,51,52,61)   ! all polar and H-bonding atoms (but not H, not C, not F)</span></div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;                                                pol_con(atom1) = pol_con(atom1)+1</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(type1)%prop(carbonyl_carbon)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;                                <span class="comment">!case (21) </span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;                                <span class="comment">!sp2 carbons which might be carbonyl, </span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                                <span class="comment">!(carbons which could be part of nitriles should be included)</span></div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                                <span class="keywordflow">if</span>(atom_data(type2)%prop(carbonyl_oxygen)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                                        <span class="comment">!case (40,43)   </span></div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;                                        <span class="comment">!carbonyl O, (nitrile N should come here)</span></div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;                                        pol_con(atom1) = pol_con(atom1)+2 <span class="comment">!carbonyl always polar</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;                                <span class="keywordflow">elseif</span>(atom_data(type2)%prop(pl_n) .or. &amp;</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;                                        atom_data(type2)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;                                        <span class="comment">!case (30:37,41,44,49,51,52,61) </span></div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;                                        <span class="comment">!all other polar atoms, see list above</span></div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;                                                pol_con(atom1) = pol_con(atom1)+1 <span class="comment">!else only count polar connections</span></div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;                        <span class="comment">!same for atom 2</span></div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;                        <span class="keywordflow">if</span>(atom_data(type2)%prop(sp3_n) .or. &amp;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;                                atom_data(type2)%prop(pl_n)) <span class="keywordflow">then</span>       </div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                                <span class="comment">!case (30:37)</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                                pol_con(atom2) = pol_con(atom2)+1</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(type2)%prop(carbon_lipo)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;                        <span class="comment">!case (20,22,23,25:29)</span></div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;                                <span class="comment">!select case (type1)</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;                                <span class="keywordflow">if</span>(atom_data(type1)%prop(pl_n) .or. &amp;</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;                                        atom_data(type1)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;                                                <span class="comment">!all polar atoms</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;                                                <span class="comment">!case (30:37,40,41,43,44,49,51,52,61)   </span></div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;                                                pol_con(atom2) = pol_con(atom2)+1</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(type2)%prop(sulphur)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;                                <span class="comment">!select case (type1)</span></div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;                                <span class="keywordflow">if</span>(atom_data(type1)%prop(pl_n) .or. &amp;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;                                        atom_data(type1)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;                                        <span class="comment">!case (30:37,40,41,43,44,49,51,52,61)   ! polar atoms</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;                                                pol_con(atom2) = pol_con(atom2)+1</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;                        <span class="keywordflow">elseif</span>(atom_data(type2)%prop(carbonyl_carbon)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;                                <span class="comment">!case (21) !sp2 carbon</span></div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;                                <span class="comment">!select case (type1)</span></div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;                                <span class="keywordflow">if</span>(atom_data(type1)%prop(carbonyl_oxygen)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;                                        <span class="comment">!case (40,43)</span></div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                                        pol_con(atom2) = pol_con(atom2)+2 <span class="comment">!carbonyl carbons are always polar</span></div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;                                <span class="keywordflow">elseif</span>(atom_data(type1)%prop(pl_n) .or. &amp;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;                                        atom_data(type1)%prop(acceptor)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;                                                <span class="comment">!case (30:37,41,44,49,51,52,61)</span></div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;                                                pol_con(atom2) = pol_con(atom2)+1</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;                                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;                <span class="comment">!store all bonds between q-atoms, pointers relating arrays q_atoms and q_bonds </span></div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;                <span class="keywordflow">if</span> ((iqatom(atom1) /= 0) .and. (iqatom(atom2) /= 0)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;                        j = iqatom(atom1)</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;                        k = iqatom(atom2)  </div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;                        nqbonds = nqbonds+1</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;                        q_bonds(nqbonds)%a =&gt; q_atoms(j)                </div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;                        q_bonds(nqbonds)%b =&gt; q_atoms(k)        <span class="comment">!pointer to atom in q_atoms</span></div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;                        q_atoms(j)%n = q_atoms(j)%n +1          <span class="comment">!number of bonds to atom j</span></div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;                        q_atoms(j)%bd(q_atoms(j)%n)%qb =&gt; q_bonds(nqbonds)      <span class="comment">!pointer to bond in q_bonds</span></div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;                                </div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;                        q_atoms(k)%n = q_atoms(k)%n +1</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;                        q_atoms(k)%bd(q_atoms(k)%n)%qb =&gt; q_bonds(nqbonds)</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;                        </div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        <span class="comment">!go through bond list once more, count bonds to polar sulphurs</span></div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;        <span class="keywordflow">do</span> i = 1,nbonds_solute</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;                atom1 = bnd(i)%i                </div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;                atom2 = bnd(i)%j</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;                type1 = iac(atom1)</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;                type2 = iac(atom2)</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;                <span class="keywordflow">if</span>(atom_data(type1)%prop(sulphur) .and. &amp;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;                        pol_con(atom1) &gt;= 1)  <span class="keywordflow">then</span> </div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;                        <span class="comment">!if ((type1 == 50) .and. (pol_con(atom1) .ge. 1))  then  </span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;                <span class="comment">!       if atom1 is a polar sulphur</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;                        <span class="comment">!select case (type2)</span></div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;                        <span class="keywordflow">if</span>(atom_data(type2)%prop(carbon_lipo) .or. &amp;</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;                                atom_data(type2)%prop(carbonyl_carbon)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;                                <span class="comment">!case (20:23,25:29)                                                             !all carbons</span></div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;                                pol_con(atom2) = pol_con(atom2)+1                       <span class="comment">!then atom2 has one more connection to a polar atom</span></div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;                        </div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;                <span class="keywordflow">if</span>(atom_data(type2)%prop(sulphur) .and. &amp;</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;                        pol_con(atom2) &gt;= 1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;                        <span class="comment">!if ((type2 == 50) .and. (pol_con(atom2) .ge. 1))  then </span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;                        <span class="comment">!if atom2 is a polar sulphur</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;                        <span class="comment">!select case (type1)</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;                        <span class="keywordflow">if</span>(atom_data(type1)%prop(carbon_lipo) .or.  &amp;</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;                                atom_data(type1)%prop(carbonyl_carbon)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;                                <span class="comment">!case (20:23,25:29)                                                     !all carbons</span></div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;                                pol_con(atom1) = pol_con(atom1)+1               <span class="comment">!then atom1 has one more connection to a polar atom</span></div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;                        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        nhbd_prot = nhbd_r              <span class="comment">!used later to keep track of waters in receptor list</span></div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;        </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a02f4a93c7e3a6a2621b7574617ce0775">sort_bonds</a></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div>
<div class="line"><a name="l01119"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a340ee3d9ab3aefb6311490a3780ba4c8"> 1119</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a340ee3d9ab3aefb6311490a3780ba4c8">sort_waters</a>  <span class="comment">!grs ev bara en gng           !in set_waters</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        <span class="keywordtype">integer</span>                                 ::i</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        <span class="keywordflow">do</span> i = 1,nwaters                                                <span class="comment">!all waters</span></div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;                <span class="keywordflow">if</span> (waters(i)%score &gt; 1) <span class="keywordflow">then</span>           <span class="comment">!if the water is attached to receptor</span></div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;                        nhbd_r = nhbd_r+1</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;                        hbd_r(nhbd_r)%heavy = waters(i)%O</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;                        hbd_r(nhbd_r)%hydr = waters(i)%H1</div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;                        </div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;                        nhbd_r = nhbd_r+1</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;                        hbd_r(nhbd_r)%heavy = waters(i)%O</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;                        hbd_r(nhbd_r)%hydr = waters(i)%H2</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;                        nhba_r = nhba_r+1</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;                        hba_r(nhba_r) = waters(i)%O     </div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a340ee3d9ab3aefb6311490a3780ba4c8">sort_waters</a></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;</div>
<div class="line"><a name="l01140"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#af43d8e5ae35fc5fd588eae032d48cb51"> 1140</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#af43d8e5ae35fc5fd588eae032d48cb51">start</a>                </div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment">!       character*80                            ::      top_file, fep_file</span></div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;        <span class="keywordtype">integer(4)</span>                                      ::      u,nat3</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        <span class="keywordtype">integer</span>                                         ::      i</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        call <a class="code" href="classmisc.html#ac616bbb70212f3216e099c51f3c217f9">centered_heading</a>(<span class="stringliteral">&#39;Reading input&#39;</span>,<span class="stringliteral">&#39;-&#39;</span>)</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;        <span class="comment">! --- topology file is now read by qcalc</span></div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;        <span class="comment">!write(*,&#39;(a)&#39;, advance=&#39;no&#39;) &#39;Topology file: &#39;</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        <span class="comment">!read (*,&#39;(a)&#39;) top_file                        </span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        <span class="comment">!top_file = &#39;hapc.top&#39;</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        <span class="comment">! --- fep file is read by score_add</span></div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;        <span class="comment">!write(*,&#39;(/,a)&#39;, advance=&#39;no&#39;) &#39;Q-atom (FEP) file: &#39;</span></div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="comment">!read (*,&#39;(a)&#39;) fep_file</span></div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        <span class="comment">!fep_file = &#39;lie.fep&#39;</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        </div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;        <span class="comment">! --- prm file is read by score_add</span></div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;        <span class="comment">!write(*,&#39;(/,a)&#39;, advance=&#39;no&#39;) &#39;Parameter file: &#39;</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;        <span class="comment">!read (*,&#39;(a)&#39;) atom_data_file</span></div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        <span class="comment">!atom_data_file = &#39;eldro.prm&#39;</span></div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <span class="comment">! --- topology is loaded by qcalc</span></div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        <span class="comment">!if(.not. topo_load(top_file, 4.00)) then</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        <span class="comment">!       write(*,&#39;(a)&#39;) &#39;&gt;&gt;&gt;&gt;&gt; ERROR: Failed to load topology.&#39;</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;        <span class="comment">!       stop</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        <span class="comment">!end if  </span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        </div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;        nwaters = (nat_pro-nat_solute)/3</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a4bb62e49849feeae28e33973facd130e">make_tac_index</a>                     <span class="comment">! creates text atom code index</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a4f53ad3d13e7c23d47c94a6a882e6bd8">get_atom_data</a>                      <span class="comment">!!! Takes vdw_radii from vdw_file and puts into vector vdwr.</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;                                                                                                        <span class="comment">!!! Also assigns radii to every solute atom</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;        <span class="keywordflow">if</span>(.not. <a class="code" href="classqatom.html#a00e760eda3603bb0bd51f6f84a4e5c9b">qatom_load_atoms</a>(fep_file)) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;                stop <span class="stringliteral">&#39;Failed to read Q-atom list from FEP file.&#39;</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;        </div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;        <span class="keyword">allocate</span>(iqatom(nat_solute))<span class="comment">! Allocate mem for every solute atom</span></div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;        iqatom(:) = 0</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;        <span class="keywordflow">do</span> i=1,nqat</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;                iqatom(iqseq(i)) = i    <span class="comment">!Set references so that iqatom = 0 if protein and {number} of ligand</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a02f4a93c7e3a6a2621b7574617ce0775">sort_bonds</a></div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a5612ee8ef3d2f944d4d10d6fd62e86f0">sort_atoms</a></div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a9ee63e29d215e66459adea3d67c95cfc">store_waters</a></div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;                </div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#af43d8e5ae35fc5fd588eae032d48cb51">start</a></div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;</div>
<div class="line"><a name="l01190"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a9ee63e29d215e66459adea3d67c95cfc"> 1190</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a9ee63e29d215e66459adea3d67c95cfc">store_waters</a> <span class="comment">!order of atoms in coordinate list must be O,H,H                !in subroutine start</span></div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        </div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        <span class="keywordtype">integer</span>                 ::i,j</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        j = 0</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        <span class="keyword">allocate</span>(waters(1:nwaters))</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        <span class="keywordflow">do</span> i = nat_solute+1,nat_pro,3</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;                j = j+1</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;                waters(j)%O = i</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;                waters(j)%H1 = i+1</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;                waters(j)%H2 = i+2</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a9ee63e29d215e66459adea3d67c95cfc">store_waters</a></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;</div>
<div class="line"><a name="l01205"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a8af51a917f080c281be0bce50c1e6d76"> 1205</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#a8af51a917f080c281be0bce50c1e6d76">angle</a>(a,b,c)</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;<span class="comment">!determines the angle a-b-c in degrees, using the cosine theorem</span></div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;        <span class="keywordtype">integer</span>                                 :: a,b,c        <span class="comment">!parameters</span></div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;        <span class="keywordtype">real</span>                                    ::ab_sq,bc_sq,ca_sq, scp <span class="comment">!local variables</span></div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;        <span class="keywordtype">real</span>, <span class="keywordtype">parameter</span> :: pi = 4.0*atan(1.0)</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;        ab_sq = <a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20">distsq</a>(a,b)</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;        bc_sq = <a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20">distsq</a>(b,c)</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        ca_sq = <a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20">distsq</a>(c,a)</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;        scp = (ab_sq+bc_sq-ca_sq)/(2*sqrt(ab_sq*bc_sq))</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        <span class="comment">!it may happen that scp is very slightly outside [-1;1]</span></div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;    <span class="keywordflow">if</span> ( scp &gt;  1.0 ) scp =  1.0</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;    <span class="keywordflow">if</span> ( scp &lt; -1.0 ) scp = -1.0</div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <a class="code" href="classcalc__chemscore.html#a8af51a917f080c281be0bce50c1e6d76">angle</a> = acos(scp)*180.0/pi</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a8af51a917f080c281be0bce50c1e6d76">angle</a></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;</div>
<div class="line"><a name="l01225"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2"> 1225</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a> (a,b)</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;        <span class="comment">!!! Gives the distance between two atoms.</span></div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;        </div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;        <span class="keywordtype">integer</span>                         ::      a,b                     <span class="comment">!topology numbers</span></div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;        <span class="keywordtype">real</span>,<span class="keywordtype">dimension(3)</span>       ::      delta</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        </div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;        <span class="keywordflow">if</span>(busexin) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;                delta = xin(3*a-2:3*a)-xin(3*b-2:3*b)</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;                delta = xtop(3*a-2:3*a)-xtop(3*b-2:3*b)                 </div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;        <a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a> = sqrt(dot_product(delta,delta))</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a></div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;</div>
<div class="line"><a name="l01240"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20"> 1240</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20">distsq</a> (a,b)</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;        <span class="comment">!!! Gives the squared distance between two atoms.</span></div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;        </div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        <span class="keywordtype">integer</span>                         ::      a,b                     </div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;        <span class="keywordtype">real</span>,<span class="keywordtype">dimension(3)</span>       ::      delta</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        <span class="keywordflow">if</span>(busexin) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;                delta = xin(3*a-2:3*a)-xin(3*b-2:3*b)</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;                delta = xtop(3*a-2:3*a)-xtop(3*b-2:3*b)</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        <a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20">distsq</a> = dot_product(delta,delta)</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a0538eec23e42416be4896f6501beec20">distsq</a></div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;</div>
<div class="line"><a name="l01256"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000"> 1256</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000">fr_lip</a>(a,b)</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;        <span class="comment">!!! Gives f(rlL) i.e. contribution from one lipophilic - lipophilic pair</span></div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;        </div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        <span class="keywordtype">integer</span>                                 ::      a,b     <span class="comment">!topology numbers of the pair</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        </div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="keywordtype">real</span>                                    ::      dr      <span class="comment">!distance between the two atoms</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        <span class="keywordtype">real</span>                                    ::  r1</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;</div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;        dr = <a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a>(a,b)</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;        r1 = vdwr(a)+vdwr(b)+0.5</div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;        <span class="keywordflow">if</span>(dr &lt; (r1+3)) <span class="keywordflow">then</span>                            <span class="comment">!if the atoms interact at all</span></div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;                <span class="keywordflow">if</span>(dr &lt;= r1) <span class="keywordflow">then</span>                       </div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;                        <a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000">fr_lip</a> = 1                                      <span class="comment">!if they are closer than R1 the interaction is given full weight</span></div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;                        <a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000">fr_lip</a> = 1-(dr-r1)/3            <span class="comment">!else the interaction is given reduced weight</span></div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;                <a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000">fr_lip</a> = 0                              </div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#aa375f714a981f45d8700a8ad88e7a000">fr_lip</a></div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;</div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;</div>
<div class="line"><a name="l01279"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59"> 1279</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59">fr_met</a>(a,b)</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;        <span class="comment">! Gives f(raM) i.e. contribution from one H-bond acceptor</span></div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;        <span class="comment">! (or H-bond acceptor/donor) - metal pair</span></div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="keywordtype">integer</span>                         ::      a,b     <span class="comment">! topology numbers</span></div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;        <span class="keywordtype">real</span>                                    ::      dr      <span class="comment">! distance between the two atoms</span></div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        </div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;        dr = <a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a>(a,b)</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        <span class="keywordflow">if</span>(dr &lt; 2.6) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;                <span class="keywordflow">if</span>(dr &lt;= 2.2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;                        <a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59">fr_met</a> = 1</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;                        <a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59">fr_met</a> = 1-(dr-2.2)/0.4</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                <a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59">fr_met</a> = 0</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a3ce8ab0790256615b1d72e31ab89ce59">fr_met</a></div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;</div>
<div class="line"><a name="l01297"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41"> 1297</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a>(a,b)        </div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;        <span class="comment">! Gives g1(dev_dr) i.e. contribution depending on the distance between</span></div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;        <span class="comment">! the H of an H-bond donor and an H-bond acceptor</span></div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        </div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        <span class="keywordtype">integer</span>                 ::      a,b                                     <span class="comment">!       top. nr</span></div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="keywordtype">real</span>                            ::      dr, dev_dr      <span class="comment">! distance between the two atoms, deviation from the</span></div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                                                                                                                        <span class="comment">! ideal value 1.85 </span></div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;        dr = <a class="code" href="classcalc__chemscore.html#aae7e243df77ac184d4fcd6cff5b0c0f2">dist</a>(a,b)</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;        dev_dr = abs(1.85-dr)</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        <span class="keywordflow">if</span>(dev_dr &lt; 0.65) <span class="keywordflow">then</span>          <span class="comment">!if atoms are interacting at all</span></div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;                <span class="keywordflow">if</span>(dev_dr &lt;= 0.25) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                        <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a> = 1</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                        <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a> = 1-(dev_dr-0.25)/0.4</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                <a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a> = 0</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a43c74c5136c8bd28466d9be8129c0c41">g1_hb</a></div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div>
<div class="line"><a name="l01318"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a"> 1318</a></span>&#160;<span class="keyword">real </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a>(a,b,c)      </div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        <span class="comment">!!! Gives g2(dev_ang) i.e. contribution depending on the H-bond angle at the hydrogen atom      </span></div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        <span class="keywordtype">integer</span>                                 ::      a,b,c                   <span class="comment">!top.nr, the hydrogen must be atom b</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        <span class="keywordtype">real</span>                                    ::      ang, dev_ang    <span class="comment">!H-bond angle, deviation from ideal value of 180 degrees</span></div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        </div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;        ang = <a class="code" href="classcalc__chemscore.html#a8af51a917f080c281be0bce50c1e6d76">angle</a>(a,b,c)</div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;        dev_ang = abs(180-ang)</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;        <span class="keywordflow">if</span>(dev_ang &lt; 80) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;                <span class="keywordflow">if</span>(dev_ang &lt;= 30) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;                        <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a> = 1</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;                        <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a> = 1-(dev_ang-30)/50</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;                <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;                <a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a> = 0</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#ad76a52480cfdcf6a556fd98bab1a3f5a">g2_hb</a></div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;</div>
<div class="line"><a name="l01337"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a1dbdeb7c4eb3b9068a041f3b08224417"> 1337</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a1dbdeb7c4eb3b9068a041f3b08224417">score_precalc</a></div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;        <span class="comment">! 1. Prepares ligand and other stuff for calculations</span></div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;        <span class="comment">! 2. Does calculations on topology or restart file before frame by frame calculations start</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;        </div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        <span class="keywordtype">integer</span>                                                 :: i</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        <span class="keywordtype">character(len=200)</span>      :: chbuf</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;        call <a class="code" href="classcalc__chemscore.html#af43d8e5ae35fc5fd588eae032d48cb51">start</a>                                              <span class="comment">! Prepares coordinates etc</span></div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a1a0ba4ea42a592ed4c0017e204372e0b">set_ligand</a>                         <span class="comment">! Prepare ligand</span></div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a96f372948049119e39d151b115758321">report_rings</a>                       <span class="comment">! output results</span></div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;        call <a class="code" href="classcalc__chemscore.html#a01a080b62749ee18b509448a22380c13">report_ligand</a>              <span class="comment">! output results</span></div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;        call <a class="code" href="classcalc__chemscore.html#af79fd6a521299e01b74e8d9ec1c113fe">report_protein</a>             <span class="comment">! output results</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        <span class="keywordflow">if</span>(bdotopcalc.eq.0) <span class="keywordflow">return</span>      <span class="comment">! abort if no top-calc is to be output</span></div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;        <span class="comment">! continue scoring topology</span></div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        call <a class="code" href="classcalc__chemscore.html#ac685deaa80ea9769e36c6b9ac8c8462d">calc_scores</a>                        <span class="comment">! does the calcs</span></div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;        score = dgconst+hbond_term*dghbond+metal_term*dgmetal+lipo_term*dglipo+rot_term*dgrot</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;        <span class="keyword">write</span>(*,*)                                      <span class="comment">!two empty lines for gnuplot as a data set separator</span></div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        <span class="keyword">write</span>(*,*)</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        call <a class="code" href="classmisc.html#ac616bbb70212f3216e099c51f3c217f9">centered_heading</a>(<span class="stringliteral">&#39;Scoring results&#39;</span>,<span class="stringliteral">&#39;=&#39;</span>)</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="keyword">write</span>(*,100) <span class="stringliteral">&#39;file&#39;</span>, <span class="stringliteral">&#39;frame&#39;</span>, <span class="stringliteral">&#39;score&#39;</span>, <span class="stringliteral">&#39;h-bonds&#39;</span>, <span class="stringliteral">&#39;metal&#39;</span>, <span class="stringliteral">&#39;lipophilic&#39;</span>, <span class="stringliteral">&#39;rot_bond&#39;</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;topology&#39;</span>, frame, score, hbond_term, metal_term, lipo_term, rot_term</div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;100     <span class="keyword">format</span>(a,     t18,a5, t29,a5,  t38,a7,   t51,a5,   t58,a10,  t71,a8)</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;110     <span class="keyword">format</span>(a,     t19,i4, t25,f9.2,t36,f9.2, t47,f9.2, t59,f9.2, t70,f9.2)</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a1dbdeb7c4eb3b9068a041f3b08224417">score_precalc</a></div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;</div>
<div class="line"><a name="l01366"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a8ac120993f6d7fd6a2d13d1de1ef8a04"> 1366</a></span>&#160;<span class="keyword">integer </span><span class="keyword">function </span><a class="code" href="classcalc__chemscore.html#a8ac120993f6d7fd6a2d13d1de1ef8a04">score_add</a>(desc)</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        <span class="comment">!arguments</span></div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;        <span class="keywordtype">character(*)</span>                            :: desc</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        <span class="keywordtype">integer</span>                                                 :: ats, ire</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;        <span class="comment">! locals        </span></div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        <span class="keywordtype">character(len=400)</span>      :: chinfile             <span class="comment">! long buffers to meet long paths</span></div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;        <span class="keywordtype">character(len=400)</span>      :: chbuf</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;        <span class="keywordflow">if</span>(nmasks == max_masks) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                <span class="keyword">write</span>(*,10) max_masks</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                <span class="keywordflow">return</span></div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;10      <span class="keyword">format</span>(<span class="stringliteral">&#39;Sorry, the maximum number of score calculations is &#39;</span>,i2)</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        <span class="comment">!add a new score mask</span></div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        nmasks = nmasks + 1</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;        call <a class="code" href="classatom__mask.html#a37135eea76c381c4aacee5cc9fbce046">mask_initialize</a>(masks(nmasks))</div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;        ats =  <a class="code" href="classmaskmanip.html#a716ed52ce2766e5a0ee111f885e7287f">maskmanip_make</a>(masks(nmasks))</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        <span class="comment">!discard if no atoms in mask</span></div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;        <span class="keywordflow">if</span>(ats == 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;                call <a class="code" href="classatom__mask.html#a7059cec5e1eecb2536e9cac6d5fb8ce0">mask_finalize</a>(masks(nmasks))</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;                nmasks = nmasks - 1</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;                <a class="code" href="classcalc__chemscore.html#a8ac120993f6d7fd6a2d13d1de1ef8a04">score_add</a> = 0</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;                <span class="keywordflow">return</span></div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        </div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;        chbuf = <span class="stringliteral">&#39;&#39;</span></div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;        <span class="keywordflow">do</span> <span class="keywordflow">while</span>((trim(chbuf).ne.<span class="stringliteral">&#39;yes&#39;</span>).and.(trim(chbuf).ne.<span class="stringliteral">&#39;no&#39;</span>))</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                call <a class="code" href="classmisc.html#a49b44c33311a31e874439a6f3caf5801">getlin</a>(chbuf,<span class="stringliteral">&#39;Score initial topology? (yes/no)&#39;</span>)</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                call <a class="code" href="classmisc.html#a809b24676ebbae2412332b832c612c3c">locase</a>(chbuf)</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;        <span class="keywordflow">if</span>(chbuf.eq.<span class="stringliteral">&#39;yes&#39;</span>) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                bdotopcalc = 1</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                bdotopcalc = 0</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                </div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;        call <a class="code" href="classmisc.html#a49b44c33311a31e874439a6f3caf5801">getlin</a>(fep_file,<span class="stringliteral">&#39;Q-atom (FEP) file: &#39;</span>)</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;        <span class="keyword">write</span>(chbuf,<span class="stringliteral">&#39;(a,a,a)&#39;</span>) <span class="stringliteral">&#39;Parameter file (blank to use &#39;</span>, trim(prm_file), <span class="stringliteral">&#39;): &#39;</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;        call <a class="code" href="classmisc.html#a49b44c33311a31e874439a6f3caf5801">getlin</a>(atom_data_file, trim(chbuf))</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        <span class="keywordflow">if</span>(len(trim(atom_data_file)).eq.0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                atom_data_file = prm_file</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;        <span class="keywordflow">end if</span></div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        <a class="code" href="classcalc__chemscore.html#a8ac120993f6d7fd6a2d13d1de1ef8a04">score_add</a> = nmasks</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        <span class="keyword">write</span>(desc, 20) nat_pro</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;20      <span class="keyword">format</span>(<span class="stringliteral">&#39;Score calculation using &#39;</span>,i6,<span class="stringliteral">&#39; atoms&#39;</span>)</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;<span class="keyword">end function </span><a class="code" href="classcalc__chemscore.html#a8ac120993f6d7fd6a2d13d1de1ef8a04">score_add</a></div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div>
<div class="line"><a name="l01419"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a745d266685ca3b123d11d20d0baf1dec"> 1419</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a745d266685ca3b123d11d20d0baf1dec">score_mean</a></div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        <span class="comment">! calculate and print mean score for all contributions</span></div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        <span class="comment">! locals</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;        <span class="keywordtype">real(8)</span>                                 :: m_score, m_hbond, m_metal, m_lipo, m_rot</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;        <span class="keywordflow">do</span> i = 1,nscores</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;                m_score = m_score + ascore(i)%score</div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                m_hbond = m_hbond + ascore(i)%h_bonds</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                m_metal = m_metal + ascore(i)%metal</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;                m_lipo  = m_lipo  + ascore(i)%lipophil</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;                m_rot   = m_rot   + ascore(i)%rot_bond</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        <span class="keywordflow">end do</span></div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;        m_score = m_score / nscores</div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;        m_hbond = m_hbond / nscores</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;        m_metal = m_metal / nscores</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;        m_lipo  = m_lipo  / nscores</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;        m_rot   = m_rot   / nscores</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;        </div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;        <span class="comment">! output mean values</span></div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        <span class="keyword">write</span>(*,100) <span class="stringliteral">&#39;processed frames: &#39;</span>, nscores,  <span class="stringliteral">&#39;score&#39;</span>, <span class="stringliteral">&#39;h-bonds&#39;</span>, <span class="stringliteral">&#39;metal&#39;</span>, <span class="stringliteral">&#39;lipophilic&#39;</span>, <span class="stringliteral">&#39;rot_bond&#39;</span></div>
<div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;100     <span class="keyword">format</span>(       t1,a,                t21,i4,    t29,a5,  t38,a7,    t51,a5,   t58,a10,     t71,a8)</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        <span class="keyword">write</span>(*,110) <span class="stringliteral">&#39;mean value&#39;</span>, m_score,   m_hbond,    m_metal,   m_lipo,    m_rot</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;110     <span class="keyword">format</span>(       t1,a,        t25,f9.2,  t36, f9.2,  t47,f9.2,  t59,f9.2,  t70,f9.2)</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        <span class="keyword">write</span>(*,111) <span class="stringliteral">&#39;------------------------------------------------------------------------------&#39;</span>                                                                     </div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;111     <span class="keyword">format</span>(t1,a)    </div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;        m_score = 0</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        m_hbond = 0</div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        m_metal = 0</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;        m_lipo  = 0</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        m_rot   = 0</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;        nscores = 0</div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a745d266685ca3b123d11d20d0baf1dec">score_mean</a></div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;</div>
<div class="line"><a name="l01455"></a><span class="lineno"><a class="code" href="classcalc__chemscore.html#a678c1ccc18920a66c00a8fe528997561"> 1455</a></span>&#160;<span class="keyword">subroutine </span><a class="code" href="classcalc__chemscore.html#a678c1ccc18920a66c00a8fe528997561">score_calc</a>(iCalc, iFrame)            ! calc topmost routine</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;        <span class="comment">!arguments</span></div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>     ::      icalc                   <span class="comment">! calculation index, not used</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;        <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>     ::      iframe                  <span class="comment">! frame index</span></div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;        <span class="comment">! &lt;begin fulhack&gt;</span></div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;        <span class="comment">! added flag to have calc routines use xin instead of xtop. not a pretty solution but better than xtop = xin &lt;end fulhack&gt;</span></div>
<div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;        busexin = .true.</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;        <span class="comment">!call start</span></div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;        <span class="comment">!call set_ligand</span></div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;        call <a class="code" href="classcalc__chemscore.html#ac685deaa80ea9769e36c6b9ac8c8462d">calc_scores</a></div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;        score = dgconst+hbond_term*dghbond+metal_term*dgmetal+lipo_term*dglipo+rot_term*dgrot</div>
<div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;</div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="comment">!       if((iFrame.eq.0).and.(iRestartCalc.eq.-1)) then         ! first restart calc, no calcs have been stored</span></div>
<div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;<span class="comment">!               iRestartCalc = 1</span></div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;<span class="comment">!               write(*,*) &#39; begin fresh restart&#39;</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;<span class="comment">!       elseif((iFrame.eq.0).and.(iRestartCalc.eq.0)) then      ! begin restart calc, last calc was trajectory calc so calc mean of that</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;<span class="comment">!               call score_calc_mean                                                    ! calc mean of traj scores</span></div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment">!               nScores = 0                                                                             ! reset frame count</span></div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;<span class="comment">!               write(*,*) &#39; begin restart&#39;</span></div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;<span class="comment">!               iRestartCalc = 1</span></div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;<span class="comment">!               call log_frame(iFrame)</span></div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;<span class="comment">!       elseif((iFrame.eq.0).and.(iRestartCalc.eq.0)) then      ! continued restart calc</span></div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;<span class="comment">!               write(*,*) &#39; cont restart&#39;</span></div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;<span class="comment">!               call log_frame(iFrame)</span></div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;<span class="comment">!       elseif((iFrame.ne.0).and.(iRestartCalc.eq.1)) then      ! begin traj calc, last was restart so calc mean of that</span></div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment">!               write(*,*) &#39; begin traj&#39;</span></div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;<span class="comment">!               call score_calc_mean</span></div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;<span class="comment">!               nScores = 0</span></div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;<span class="comment">!               iRestartCalc = 0</span></div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;<span class="comment">!               call log_frame(iFrame)</span></div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;<span class="comment">!       elseif((iFrame.ne.0).and.(iRestartCalc.eq.0)) then      ! continued traj calc</span></div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="comment">!               write(*,*) &#39; cont traj&#39;</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;<span class="comment">!               call log_frame(iFrame)</span></div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;<span class="comment">!       else</span></div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;<span class="comment">!               write(*,*) &#39; &gt;&gt;&gt;&gt; ERROR: Unrecognized calculation type in score_calc&#39;</span></div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;<span class="comment">!       end if</span></div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        call <a class="code" href="classcalc__chemscore.html#ac981dadd7632147eefe3240bada21d79">log_frame</a>(iframe)</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;        <span class="comment">!write(110,*) score, hbond_term, metal_term, lipo_term, rot_term</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="comment">!       write(100,*) score, hbond_term, metal_term, lipo_term, rot_term</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;        <span class="comment">!write(*,100, advance=&#39;no&#39;) score</span></div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;100     <span class="keyword">format</span>(f10.3)</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;        <span class="keyword">write</span>(*, 110) score,    hbond_term, metal_term, lipo_term, rot_term</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;110     <span class="keyword">format</span>(       t25,f9.2, t36,f9.2,   t47,f9.2,   t59,f9.2,  t70,f9.2)</div>
<div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;</div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="keyword">end subroutine </span><a class="code" href="classcalc__chemscore.html#a678c1ccc18920a66c00a8fe528997561">score_calc</a></div>
<div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;<span class="keyword">end module </span><a class="code" href="classcalc__chemscore.html">calc_chemscore</a></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 9 2015 09:31:33 for qsource by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
